<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico PWA - Teletrabajo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 15px;
            background: #f8fafc;
            font-size: 14px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
            margin-bottom: 15px;
            font-size: 22px;
        }
        h2 {
            color: #1e40af;
            margin: 20px 0 10px 0;
            font-size: 18px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
        }
        .check {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #64748b;
        }
        .check.ok {
            background: #f0fdf4;
            border-color: #10b981;
        }
        .check.error {
            background: #fef2f2;
            border-color: #ef4444;
        }
        .check.warning {
            background: #fffbeb;
            border-color: #f59e0b;
        }
        .label {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .value {
            font-family: 'Courier New', monospace;
            background: rgba(0,0,0,0.05);
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
            margin: 2px 0;
            word-break: break-all;
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #1e40af;
        }
        .console-log {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-item {
            margin: 3px 0;
            padding: 2px 0;
        }
        .log-ok { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-warn { color: #f59e0b; }
        .icon { margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico Completo de PWA</h1>
        <p style="margin-bottom: 20px; color: #64748b;">
            Esta p√°gina verifica TODO lo necesario para que la PWA funcione correctamente en Android.
        </p>
        
        <div id="results"></div>
        
        <h2>üìã Console Logs</h2>
        <div class="console-log" id="console"></div>
        
        <div style="margin-top: 20px;">
            <button onclick="ejecutarDiagnostico()">üîÑ Ejecutar Diagn√≥stico Completo</button>
            <button onclick="window.location.href='./'" style="background: #10b981;">‚úÖ Ir a la App</button>
            <button onclick="limpiarCache()" style="background: #ef4444;">üóëÔ∏è Limpiar Cach√©</button>
        </div>
    </div>

    <script>
        const consoleDiv = document.getElementById('console');
        const resultsDiv = document.getElementById('results');
        
        function log(message, type = 'info') {
            const span = document.createElement('div');
            span.className = `log-item log-${type}`;
            const icon = type === 'ok' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            span.innerHTML = `<span class="icon">${icon}</span>${message}`;
            consoleDiv.appendChild(span);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }
        
        function addCheck(title, status, message, details = '') {
            const div = document.createElement('div');
            div.className = `check ${status}`;
            div.innerHTML = `
                <div class="label">${title}</div>
                <div>${message}</div>
                ${details ? `<div style="margin-top: 5px; font-size: 12px; color: #64748b;">${details}</div>` : ''}
            `;
            resultsDiv.appendChild(div);
        }
        
        async function ejecutarDiagnostico() {
            resultsDiv.innerHTML = '';
            consoleDiv.innerHTML = '';
            
            log('üöÄ Iniciando diagn√≥stico completo...', 'info');
            
            // 1. Protocolo HTTPS
            log('Verificando protocolo...', 'info');
            const protocol = window.location.protocol;
            const isHTTPS = protocol === 'https:' || window.location.hostname === 'localhost';
            addCheck(
                'üîí Protocolo HTTPS',
                isHTTPS ? 'ok' : 'error',
                isHTTPS ? `Usando ${protocol} ‚úì` : 'Necesitas HTTPS para PWA',
                isHTTPS ? 'Las PWA requieren HTTPS (o localhost)' : 'GitHub Pages proporciona HTTPS autom√°ticamente'
            );
            log(isHTTPS ? '‚úÖ HTTPS: OK' : '‚ùå HTTPS: FALTA', isHTTPS ? 'ok' : 'error');
            
            // 2. Service Worker Support
            log('Verificando soporte Service Worker...', 'info');
            const hasSW = 'serviceWorker' in navigator;
            addCheck(
                '‚öôÔ∏è Service Worker',
                hasSW ? 'ok' : 'error',
                hasSW ? 'Navegador soporta Service Workers ‚úì' : 'Navegador NO soporta Service Workers',
                hasSW ? 'Service Worker disponible' : 'Cambia a Chrome, Edge o Safari'
            );
            log(hasSW ? '‚úÖ Service Worker: Soportado' : '‚ùå Service Worker: NO soportado', hasSW ? 'ok' : 'error');
            
            // 3. Manifest
            log('Cargando manifest...', 'info');
            try {
                const manifestLink = document.querySelector('link[rel="manifest"]');
                if (!manifestLink) {
                    throw new Error('No se encontr√≥ link al manifest en el HTML');
                }
                
                const manifestUrl = new URL(manifestLink.href, window.location.href);
                log(`Manifest URL: ${manifestUrl}`, 'info');
                
                const manifestResponse = await fetch(manifestUrl);
                if (!manifestResponse.ok) {
                    throw new Error(`HTTP ${manifestResponse.status}`);
                }
                
                const manifest = await manifestResponse.json();
                addCheck(
                    'üìÑ Manifest',
                    'ok',
                    `Manifest cargado: "${manifest.name}" ‚úì`,
                    `Start URL: ${manifest.start_url} | Display: ${manifest.display} | ${manifest.icons.length} iconos`
                );
                log('‚úÖ Manifest: OK', 'ok');
                log(`   - Nombre: ${manifest.name}`, 'info');
                log(`   - Display: ${manifest.display}`, 'info');
                log(`   - Iconos: ${manifest.icons.length}`, 'info');
                
                // Verificar cada icono
                for (const icon of manifest.icons) {
                    log(`Verificando icono: ${icon.src}`, 'info');
                    try {
                        const iconUrl = new URL(icon.src, window.location.href);
                        const iconResponse = await fetch(iconUrl);
                        if (iconResponse.ok) {
                            log(`   ‚úÖ ${icon.src} (${icon.sizes}) - OK`, 'ok');
                        } else {
                            log(`   ‚ùå ${icon.src} - HTTP ${iconResponse.status}`, 'error');
                        }
                    } catch (e) {
                        log(`   ‚ùå ${icon.src} - ${e.message}`, 'error');
                    }
                }
                
            } catch (e) {
                addCheck(
                    'üìÑ Manifest',
                    'error',
                    'Error cargando manifest',
                    e.message
                );
                log(`‚ùå Manifest: ERROR - ${e.message}`, 'error');
            }
            
            // 4. Service Worker registrado
            if (hasSW) {
                log('Verificando Service Worker registrado...', 'info');
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        addCheck(
                            '‚úÖ Service Worker Activo',
                            'ok',
                            'Service Worker registrado y activo ‚úì',
                            `Scope: ${registration.scope} | State: ${registration.active ? registration.active.state : 'N/A'}`
                        );
                        log('‚úÖ Service Worker registrado', 'ok');
                        log(`   - Scope: ${registration.scope}`, 'info');
                        log(`   - State: ${registration.active ? registration.active.state : 'N/A'}`, 'info');
                    } else {
                        addCheck(
                            '‚ö†Ô∏è Service Worker',
                            'warning',
                            'Service Worker no registrado',
                            'Recarga la p√°gina principal para registrarlo'
                        );
                        log('‚ö†Ô∏è Service Worker: No registrado a√∫n', 'warn');
                    }
                } catch (e) {
                    addCheck(
                        '‚ùå Service Worker',
                        'error',
                        'Error verificando Service Worker',
                        e.message
                    );
                    log(`‚ùå Service Worker: ${e.message}`, 'error');
                }
            }
            
            // 5. beforeinstallprompt
            log('Esperando evento beforeinstallprompt...', 'info');
            let promptEventReceived = false;
            
            const promptPromise = new Promise((resolve) => {
                window.addEventListener('beforeinstallprompt', (e) => {
                    promptEventReceived = true;
                    resolve(true);
                });
                
                // Timeout despu√©s de 2 segundos
                setTimeout(() => resolve(false), 2000);
            });
            
            const received = await promptPromise;
            
            addCheck(
                'üì± beforeinstallprompt',
                received ? 'ok' : 'warning',
                received ? 'Evento recibido - PWA instalable ‚úì' : 'Evento NO recibido',
                received ? 
                    'El navegador permitir√° instalar la PWA' : 
                    'Posibles causas: Ya instalada, manifest incompleto, iconos faltantes, o Chrome decidi√≥ no mostrar el prompt'
            );
            log(received ? '‚úÖ beforeinstallprompt: Recibido' : '‚ö†Ô∏è beforeinstallprompt: NO recibido', received ? 'ok' : 'warn');
            
            // 6. Display mode
            log('Verificando display mode...', 'info');
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
            addCheck(
                'üì∫ Display Mode',
                isStandalone ? 'ok' : 'warning',
                isStandalone ? 'Ejecut√°ndose como app standalone ‚úì' : 'Ejecut√°ndose en navegador',
                isStandalone ? 'La PWA ya est√° instalada' : 'Para modo standalone, instala la app'
            );
            log(isStandalone ? '‚úÖ Display: Standalone (instalada)' : '‚ÑπÔ∏è Display: Browser (no instalada)', isStandalone ? 'ok' : 'info');
            
            // 7. Informaci√≥n del navegador
            log('Recopilando info del navegador...', 'info');
            const ua = navigator.userAgent;
            const isChrome = /Chrome/.test(ua) && /Google Inc/.test(navigator.vendor);
            const isEdge = /Edg/.test(ua);
            const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua);
            const isFirefox = /Firefox/.test(ua);
            
            let browser = 'Desconocido';
            let browserOk = false;
            if (isChrome) { browser = 'Chrome'; browserOk = true; }
            else if (isEdge) { browser = 'Edge'; browserOk = true; }
            else if (isSafari) { browser = 'Safari'; browserOk = true; }
            else if (isFirefox) { browser = 'Firefox'; browserOk = false; }
            
            addCheck(
                'üåê Navegador',
                browserOk ? 'ok' : 'warning',
                `Navegador: ${browser}`,
                browserOk ? 'Compatible con PWA' : 'Firefox tiene soporte limitado de PWA'
            );
            log(`‚ÑπÔ∏è Navegador: ${browser}`, 'info');
            
            // Resumen final
            log('', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('üìä RESUMEN DEL DIAGN√ìSTICO', 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            
            if (isHTTPS && hasSW && received) {
                log('‚úÖ TODO PERFECTO - La PWA deber√≠a instalarse', 'ok');
                log('üí° Si el bot√≥n no funciona, prueba el men√∫ (‚ãÆ) ‚Üí Instalar', 'info');
            } else if (isHTTPS && hasSW && !received) {
                log('‚ö†Ô∏è CASI LISTO - Falta evento beforeinstallprompt', 'warn');
                log('üí° Posibles soluciones:', 'info');
                log('   1. La app ya est√° instalada (desinst√°lala primero)', 'info');
                log('   2. Faltan los iconos PNG en el servidor', 'info');
                log('   3. Chrome ya mostr√≥ el prompt y fue rechazado', 'info');
                log('   4. Usa el men√∫ (‚ãÆ) ‚Üí Instalar aplicaci√≥n', 'info');
            } else {
                log('‚ùå HAY PROBLEMAS - Revisa los errores arriba', 'error');
            }
        }
        
        async function limpiarCache() {
            if ('caches' in window) {
                const keys = await caches.keys();
                await Promise.all(keys.map(key => caches.delete(key)));
                alert('‚úÖ Cach√© limpiada. Recarga la p√°gina.');
            } else {
                alert('Este navegador no soporta Cache API');
            }
        }
        
        // Ejecutar autom√°ticamente al cargar
        window.addEventListener('load', () => {
            setTimeout(ejecutarDiagnostico, 500);
        });
    </script>
</body>
</html>
