<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="App para reuniones telem√°ticas con orden del d√≠a y votaciones">
    <link rel="manifest" href="manifest-teletrabajo.json">
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìã</text></svg>">
    <title>Teletrabajo Capitulaciones</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --coordinador: #8b5cf6;
            --maestro: #06b6d4;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .code-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .code-display .code {
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .code-display p {
            font-size: 14px;
            opacity: 0.95;
            margin-top: 10px;
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }

        .user-badge.coordinador {
            background: rgba(139, 92, 246, 0.1);
            color: var(--coordinador);
            border: 2px solid var(--coordinador);
        }

        .user-badge.maestro {
            background: rgba(6, 182, 212, 0.1);
            color: var(--maestro);
            border: 2px solid var(--maestro);
        }

        .punto-item {
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .punto-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .punto-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .punto-numero {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .punto-titulo {
            font-weight: 600;
            font-size: 16px;
            flex-grow: 1;
            padding: 0 15px;
        }

        .aportacion {
            background: white;
            border-left: 4px solid var(--secondary);
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: all 0.2s;
        }

        .aportacion:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }

        .aportacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .aportacion-autor {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary);
        }

        .aportacion-hora {
            font-size: 11px;
            color: var(--text-light);
        }

        .aportacion-texto {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text);
            word-wrap: break-word;
        }

        .votacion-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }

        .votacion-opciones {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .voto-btn {
            padding: 15px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voto-btn:hover,
        .voto-btn.selected {
            background: white;
            color: var(--primary);
            transform: scale(1.05);
        }

        .resultados-votacion {
            background: white;
            color: var(--text);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .resultado-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: var(--background);
            border-radius: 6px;
        }

        .resultado-barra {
            flex-grow: 1;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin: 0 15px;
        }

        .resultado-progreso {
            height: 100%;
            background: var(--primary);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .info-box {
            background: rgba(37, 99, 235, 0.1);
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state .emoji {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .chat-container {
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        .session-info {
            background: var(--background);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-code {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .status-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .status-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .btn-group {
                grid-template-columns: 1fr;
            }

            .code-display .code {
                font-size: 36px;
                letter-spacing: 6px;
            }

            .votacion-opciones {
                grid-template-columns: 1fr;
            }

            .status-indicator {
                top: auto;
                bottom: 20px;
                right: 20px;
            }
        }

        /* Banner de videollamada */
        .videollamada-banner {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .videollamada-banner-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .videollamada-icon {
            font-size: 24px;
            animation: pulse 2s infinite;
        }

        .videollamada-texto {
            flex: 1;
        }

        .videollamada-texto strong {
            display: block;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .videollamada-texto small {
            opacity: 0.9;
            font-size: 13px;
        }

        .videollamada-actions {
            display: flex;
            gap: 8px;
        }

        .btn-videollamada {
            background: white;
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-videollamada:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-videollamada-edit {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .btn-videollamada-edit:hover {
            background: rgba(255,255,255,0.3);
        }

        @media (max-width: 768px) {
            .videollamada-banner {
                flex-direction: column;
                align-items: stretch;
            }

            .videollamada-actions {
                flex-direction: column;
            }

            .btn-videollamada {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Teletrabajo Capitulaciones</h1>
        <div class="subtitle">CEIP Capitulaciones de Santa Fe</div>
    </div>

    <div class="status-indicator" id="statusIndicator" style="display: none;">
        Conectado en tiempo real
    </div>

    <!-- Pantalla de inicio -->
    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="card">
                <h2>Bienvenido</h2>
                <div class="form-group">
                    <label>Tu nombre:</label>
                    <input type="text" id="inputNombre" placeholder="Ej: Mar√≠a Garc√≠a">
                </div>
                <div class="form-group">
                    <label>Tu rol:</label>
                    <select id="selectRol">
                        <option value="maestro">Maestro/a</option>
                        <option value="coordinador">Coordinador/a</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2>Seleccionar Reuni√≥n</h2>
                <div class="form-group">
                    <label>Curso / Ciclo / Equipo / √ìrgano Colegiado:</label>
                    <select id="selectReunion">
                        <option value="">-- Selecciona --</option>
                        <optgroup label="üé® Educaci√≥n Infantil">
                            <option value="infantil-3">Infantil 3 a√±os</option>
                            <option value="infantil-4">Infantil 4 a√±os</option>
                            <option value="infantil-5">Infantil 5 a√±os</option>
                        </optgroup>
                        <optgroup label="üìö Educaci√≥n Primaria">
                            <option value="primero">1¬∫ de Primaria</option>
                            <option value="segundo">2¬∫ de Primaria</option>
                            <option value="tercero">3¬∫ de Primaria</option>
                            <option value="cuarto">4¬∫ de Primaria</option>
                            <option value="quinto">5¬∫ de Primaria</option>
                            <option value="sexto">6¬∫ de Primaria</option>
                        </optgroup>
                        <optgroup label="üîÑ Ciclos">
                            <option value="ciclo-infantil">Ciclo Infantil</option>
                            <option value="primer-ciclo">Primer Ciclo Primaria (1¬∫-2¬∫)</option>
                            <option value="segundo-ciclo">Segundo Ciclo Primaria (3¬∫-4¬∫)</option>
                            <option value="tercer-ciclo">Tercer Ciclo Primaria (5¬∫-6¬∫)</option>
                        </optgroup>
                        <optgroup label="üë• Equipos y Aulas">
                            <option value="orientacion">Equipo de Orientaci√≥n</option>
                            <option value="aula-tea">Aula TEA</option>
                        </optgroup>
                        <optgroup label="üèõÔ∏è √ìrganos Colegiados">
                            <option value="claustro">Claustro</option>
                            <option value="etcp">ETCP (Equipo T√©cnico de Coordinaci√≥n Pedag√≥gica)</option>
                            <option value="consejo-escolar">Consejo Escolar</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de la reuni√≥n:</label>
                    <input type="date" id="inputFecha" value="">
                </div>
                <div class="info-box">
                    ‚ÑπÔ∏è <strong>Coordinador:</strong> Crea una nueva reuni√≥n con la fecha indicada<br>
                    ‚ÑπÔ∏è <strong>Maestro:</strong> √önete a la reuni√≥n existente (debe estar creada por el coordinador)<br>
                    ‚ÑπÔ∏è Las reuniones quedan guardadas permanentemente por fecha
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="crearSesion()">
                        ‚ûï Crear Reuni√≥n
                    </button>
                    <button class="btn btn-secondary" onclick="unirseASesion()">
                        üöÄ Unirse a Reuni√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de configuraci√≥n (solo coordinador) -->
    <div id="screenConfig" class="screen">
        <div class="container">
            <div class="code-display">
                <div>Reuni√≥n de:</div>
                <div class="code" id="nombreReunion" style="font-size: 32px; letter-spacing: 2px;">------</div>
                <p>Los participantes deben seleccionar la misma opci√≥n para unirse</p>
            </div>

            <div class="card">
                <h2>Orden del D√≠a</h2>
                <div class="info-box">
                    ‚ÑπÔ∏è Define los puntos que se tratar√°n en la reuni√≥n
                </div>
                <div id="listaPuntos"></div>
                <div class="form-group">
                    <label>Nuevo punto del orden del d√≠a:</label>
                    <input type="text" id="inputNuevoPunto" placeholder="Ej: Revisi√≥n de objetivos del trimestre">
                </div>
                <button class="btn btn-secondary" onclick="agregarPunto()">
                    ‚ûï Agregar Punto
                </button>
            </div>

            <button class="btn btn-primary" onclick="iniciarReunion()" style="margin-top: 20px;">
                üöÄ Iniciar Reuni√≥n
            </button>
        </div>
    </div>

    <!-- Pantalla de reuni√≥n -->
    <div id="screenReunion" class="screen">
        <div class="container">
            <div class="session-info">
                <div>
                    <strong>Reuni√≥n:</strong> <span class="session-code" id="nombreActual" style="font-size: 16px;"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-small" onclick="exportarPDF()">
                        üìÑ Exportar PDF
                    </button>
                    <button class="btn btn-danger btn-small" onclick="salirDeReunion()">
                        üö™ Salir
                    </button>
                </div>
            </div>

            <!-- Banner de videollamada -->
            <div id="videollamadaBanner"></div>

            <!-- Bot√≥n para gestionar videollamada (solo coordinador) -->
            <div id="gestionVideollamada"></div>

            <div class="card">
                <h2>Participantes <span id="numParticipantes"></span></h2>
                <div id="listaParticipantes"></div>
            </div>

            <div id="contenidoPuntos"></div>
        </div>
    </div>

    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get, update, onChildAdded, onChildChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDchcaSp2M8uRZxMbMG7sop_ypkZP7w8CI",
            authDomain: "teletrabajo-capitulaciones.firebaseapp.com",
            databaseURL: "https://teletrabajo-capitulaciones-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "teletrabajo-capitulaciones",
            storageBucket: "teletrabajo-capitulaciones.firebasestorage.app",
            messagingSenderId: "227282426388",
            appId: "1:227282426388:web:2e1e4a600d069f60b8a501"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Variables globales
        let sesionActual = null;
        let usuarioActual = null;
        let fechaActual = null;
        let puntosListeners = {}; // Almacenar referencias a los listeners para evitar duplicaci√≥n

        // Exponer funciones al scope global
        window.database = database;
        window.ref = ref;
        window.set = set;
        window.push = push;
        window.onValue = onValue;
        window.remove = remove;
        window.get = get;
        window.update = update;
        window.onChildAdded = onChildAdded;
        window.onChildChanged = onChildChanged;
        
        window.sesionActual = null;
        window.usuarioActual = null;
        window.fechaActual = null;

        // Mostrar indicador de conexi√≥n
        document.getElementById('statusIndicator').style.display = 'flex';

        // Diccionario de nombres amigables
        const nombresReunion = {
            'infantil-3': 'Infantil 3 a√±os',
            'infantil-4': 'Infantil 4 a√±os',
            'infantil-5': 'Infantil 5 a√±os',
            'primero': '1¬∫ de Primaria',
            'segundo': '2¬∫ de Primaria',
            'tercero': '3¬∫ de Primaria',
            'cuarto': '4¬∫ de Primaria',
            'quinto': '5¬∫ de Primaria',
            'sexto': '6¬∫ de Primaria',
            'ciclo-infantil': 'Ciclo Infantil',
            'primer-ciclo': 'Primer Ciclo Primaria',
            'segundo-ciclo': 'Segundo Ciclo Primaria',
            'tercer-ciclo': 'Tercer Ciclo Primaria',
            'orientacion': 'Equipo de Orientaci√≥n',
            'aula-tea': 'Aula TEA',
            'claustro': 'Claustro',
            'etcp': 'ETCP (Equipo T√©cnico de Coordinaci√≥n Pedag√≥gica)',
            'consejo-escolar': 'Consejo Escolar'
        };

        // Formatear fecha
        window.formatearFecha = function(fecha) {
            const partes = fecha.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        };

        // Obtener nombre amigable
        window.getNombreReunion = function(id, fecha) {
            return nombresReunion[id] + ' - ' + formatearFecha(fecha);
        };

        // Cambiar pantalla
        window.cambiarPantalla = function(pantalla) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(pantalla).classList.add('active');
        };

        // Establecer fecha de hoy por defecto
        document.getElementById('inputFecha').valueAsDate = new Date();

        // Crear sesi√≥n
        window.crearSesion = async function() {
            const nombre = document.getElementById('inputNombre').value.trim();
            const rol = document.getElementById('selectRol').value;
            const idReunion = document.getElementById('selectReunion').value;
            const fecha = document.getElementById('inputFecha').value;

            if (!nombre) {
                alert('Por favor, introduce tu nombre');
                return;
            }

            if (!idReunion) {
                alert('Por favor, selecciona un curso/ciclo/equipo/√≥rgano');
                return;
            }

            if (!fecha) {
                alert('Por favor, selecciona una fecha para la reuni√≥n');
                return;
            }

            if (rol !== 'coordinador') {
                alert('Solo el coordinador puede crear reuniones. Usa "Unirse a Reuni√≥n"');
                return;
            }

            window.sesionActual = idReunion;
            window.fechaActual = fecha;
            window.usuarioActual = { nombre, rol };

            // Verificar si ya existe la reuni√≥n
            const sesionRef = ref(database, `sesiones/${idReunion}/${fecha}`);
            const snapshot = await get(sesionRef);

            if (snapshot.exists()) {
                // La reuni√≥n ya existe
                const sesionData = snapshot.val();
                const confirmacion = confirm(
                    `Ya existe una reuni√≥n de ${getNombreReunion(idReunion, fecha)} creada el ${new Date(sesionData.creada).toLocaleString('es-ES')}.\n\n` +
                    `¬øQu√© quieres hacer?\n\n` +
                    `OK = Continuar editando esta reuni√≥n\n` +
                    `Cancelar = Volver atr√°s`
                );
                
                if (!confirmacion) {
                    return;
                }
                
                // Configurar y mostrar pantalla de configuraci√≥n
                document.getElementById('nombreReunion').textContent = getNombreReunion(idReunion, fecha);
                setupPuntosListener();
                cambiarPantalla('screenConfig');
            } else {
                // Crear nueva reuni√≥n
                await set(sesionRef, {
                    creada: Date.now(),
                    estado: 'configurando',
                    fecha: fecha,
                    nombre: getNombreReunion(idReunion, fecha)
                });
                
                document.getElementById('nombreReunion').textContent = getNombreReunion(idReunion, fecha);
                setupPuntosListener();
                cambiarPantalla('screenConfig');
            }
        };

        // Unirse a sesi√≥n
        window.unirseASesion = async function() {
            const nombre = document.getElementById('inputNombre').value.trim();
            const rol = document.getElementById('selectRol').value;
            const idReunion = document.getElementById('selectReunion').value;
            const fecha = document.getElementById('inputFecha').value;

            if (!nombre) {
                alert('Por favor, introduce tu nombre');
                return;
            }

            if (!idReunion) {
                alert('Por favor, selecciona un curso/ciclo/equipo/√≥rgano');
                return;
            }

            if (!fecha) {
                alert('Por favor, selecciona una fecha para la reuni√≥n');
                return;
            }

            window.sesionActual = idReunion;
            window.fechaActual = fecha;
            window.usuarioActual = { nombre, rol };

            // Verificar si existe la reuni√≥n
            const sesionRef = ref(database, `sesiones/${idReunion}/${fecha}`);
            const snapshot = await get(sesionRef);

            if (!snapshot.exists()) {
                alert('La reuni√≥n no existe. El coordinador debe crearla primero.');
                return;
            }

            const sesionData = snapshot.val();

            // Registrar como participante
            const participanteRef = ref(database, `sesiones/${idReunion}/${fecha}/participantes/${nombre}`);
            await set(participanteRef, {
                nombre: nombre,
                rol: rol,
                timestamp: Date.now()
            });

            // Si la reuni√≥n a√∫n est√° en configuraci√≥n y eres coordinador, ir a configuraci√≥n
            if (sesionData.estado === 'configurando' && rol === 'coordinador') {
                document.getElementById('nombreReunion').textContent = getNombreReunion(idReunion, fecha);
                setupPuntosListener();
                cambiarPantalla('screenConfig');
                return;
            }

            // En cualquier otro caso, llevar a la pantalla de reuni√≥n
            document.getElementById('nombreActual').textContent = getNombreReunion(idReunion, fecha);
            cargarReunion();
            cambiarPantalla('screenReunion');
        };

        // Agregar punto del orden del d√≠a
        window.agregarPunto = function() {
            const texto = document.getElementById('inputNuevoPunto').value.trim();
            if (!texto) {
                alert('Escribe el punto del orden del d√≠a');
                return;
            }

            const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
            const nuevoPuntoRef = push(puntosRef);
            
            set(nuevoPuntoRef, {
                texto: texto,
                orden: Date.now()
            });

            document.getElementById('inputNuevoPunto').value = '';
        };

        // Eliminar punto
        window.eliminarPunto = function(puntoId) {
            const puntoRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}`);
            remove(puntoRef);
        };

        // Iniciar reuni√≥n
        window.iniciarReunion = async function() {
            const sesionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}`);
            update(sesionRef, { estado: 'activa' });

            // Registrar coordinador como participante
            const participanteRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/participantes/${window.usuarioActual.nombre}`);
            set(participanteRef, {
                nombre: window.usuarioActual.nombre,
                rol: window.usuarioActual.rol,
                timestamp: Date.now()
            });

            document.getElementById('nombreActual').textContent = getNombreReunion(window.sesionActual, window.fechaActual);
            cargarReunion();
            cambiarPantalla('screenReunion');
        };

        // Cargar reuni√≥n - CORREGIDO: Eliminado el listener duplicado de puntos
        window.cargarReunion = function() {
            cargarParticipantes();
            cargarPuntos(); // Solo carga inicial, sin listener global
            cargarVideollamada();

            // Escuchar cambios en participantes
            const participantesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/participantes`);
            onValue(participantesRef, () => {
                cargarParticipantes();
            });

            // Escuchar cambios en videollamada
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            onValue(videollamadaRef, () => {
                cargarVideollamada();
            });

            // NUEVO: Listener para nuevos puntos y eliminaciones
            const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
            onValue(puntosRef, (snapshot) => {
                // Solo actualizar la lista de puntos sin recrear todos los listeners
                actualizarListaPuntos(snapshot);
            });
        };

        // NUEVA funci√≥n para actualizar lista de puntos sin recrear listeners
        window.actualizarListaPuntos = function(snapshot) {
            const contenedor = document.getElementById('contenidoPuntos');
            
            if (!snapshot.exists()) {
                contenedor.innerHTML = '<div class="empty-state"><div class="emoji">üìã</div><p>No hay puntos del orden del d√≠a</p></div>';
                return;
            }

            const puntos = snapshot.val();
            const puntosArray = Object.entries(puntos).map(([id, data]) => ({ id, ...data }));
            puntosArray.sort((a, b) => a.orden - b.orden);

            // Obtener IDs actuales en el DOM
            const puntosActualesDOM = Array.from(contenedor.querySelectorAll('.card[data-punto-id]'))
                .map(el => el.getAttribute('data-punto-id'));
            
            const puntosNuevosIDs = puntosArray.map(p => p.id);

            // Eliminar puntos que ya no existen
            puntosActualesDOM.forEach(id => {
                if (!puntosNuevosIDs.includes(id)) {
                    const elemento = contenedor.querySelector(`[data-punto-id="${id}"]`);
                    if (elemento) elemento.remove();
                }
            });

            // A√±adir nuevos puntos o reordenar
            puntosArray.forEach((punto, index) => {
                let card = contenedor.querySelector(`[data-punto-id="${punto.id}"]`);
                
                if (!card) {
                    // Crear nuevo punto
                    card = crearPuntoCard(punto, index + 1);
                    contenedor.appendChild(card);
                } else {
                    // Actualizar n√∫mero si es necesario
                    const numeroEl = card.querySelector('.punto-numero');
                    if (numeroEl) numeroEl.textContent = index + 1;
                }
            });
        };

        // Cargar participantes
        window.cargarParticipantes = async function() {
            const lista = document.getElementById('listaParticipantes');
            lista.innerHTML = '';

            const participantesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/participantes`);
            const snapshot = await get(participantesRef);

            if (!snapshot.exists()) {
                document.getElementById('numParticipantes').textContent = '(0)';
                return;
            }

            const participantes = snapshot.val();
            const participantesArray = Object.values(participantes);

            participantesArray.forEach(p => {
                const badge = document.createElement('span');
                badge.className = `user-badge ${p.rol}`;
                badge.innerHTML = `${p.rol === 'coordinador' ? 'üëë' : 'üë§'} ${p.nombre}`;
                lista.appendChild(badge);
            });

            document.getElementById('numParticipantes').textContent = `(${participantesArray.length})`;
        };

        // Cargar puntos del orden del d√≠a - Solo carga inicial
        window.cargarPuntos = async function() {
            const contenedor = document.getElementById('contenidoPuntos');
            contenedor.innerHTML = '';

            const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
            const snapshot = await get(puntosRef);

            if (!snapshot.exists()) {
                contenedor.innerHTML = '<div class="empty-state"><div class="emoji">üìã</div><p>No hay puntos del orden del d√≠a</p></div>';
                return;
            }

            const puntos = snapshot.val();
            const puntosArray = Object.entries(puntos).map(([id, data]) => ({ id, ...data }));
            puntosArray.sort((a, b) => a.orden - b.orden);

            puntosArray.forEach((punto, index) => {
                const card = crearPuntoCard(punto, index + 1);
                contenedor.appendChild(card);
            });
        };

        // Crear card de punto - MODIFICADO para incluir data-punto-id
        window.crearPuntoCard = function(punto, numero) {
            const card = document.createElement('div');
            card.className = 'card';
            card.setAttribute('data-punto-id', punto.id); // Identificador √∫nico
            card.innerHTML = `
                <div class="punto-header">
                    <div class="punto-numero">${numero}</div>
                    <div class="punto-titulo">${punto.texto}</div>
                </div>

                ${window.usuarioActual.rol === 'coordinador' ? `
                <div style="margin: 20px 0; padding: 15px; background: var(--background); border-radius: 8px;">
                    <strong style="display: block; margin-bottom: 10px;">üìé Adjuntar documento:</strong>
                    <div style="display: grid; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="nombre_doc_${punto.id}" placeholder="Nombre del documento (ej: Objetivos Trimestre 1)" style="margin: 0;">
                        <input type="url" id="link_doc_${punto.id}" placeholder="Enlace de Google Drive (o cualquier URL)" style="margin: 0;">
                    </div>
                    <button class="btn btn-outline btn-small" onclick="adjuntarDocumento('${punto.id}')" style="width: 100%;">
                        üìé Adjuntar
                    </button>
                </div>
                ` : ''}

                <div id="documentos_${punto.id}" style="margin: 20px 0;"></div>

                <div style="margin: 20px 0;">
                    <strong style="display: block; margin-bottom: 10px;">üí¨ Conversaci√≥n:</strong>
                    <div id="aportaciones_${punto.id}" class="chat-container"></div>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <textarea id="input_${punto.id}" placeholder="Escribe tu comentario... (Enter para enviar, Shift+Enter para nueva l√≠nea)" style="flex: 1; margin: 0; min-height: 60px;" rows="2" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); agregarAportacion('${punto.id}'); }"></textarea>
                        <button class="btn btn-secondary" onclick="agregarAportacion('${punto.id}')" style="width: auto; padding: 12px 20px; margin: 0; height: fit-content;">
                            üìù Enviar
                        </button>
                    </div>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                    <strong style="display: block; margin-bottom: 10px;">üó≥Ô∏è Votaci√≥n:</strong>
                    ${window.usuarioActual.rol === 'coordinador' ? `
                        <div class="btn-group">
                            <button class="btn btn-outline btn-small" onclick="crearVotacion('${punto.id}', false)">
                                Votaci√≥n An√≥nima
                            </button>
                            <button class="btn btn-outline btn-small" onclick="crearVotacion('${punto.id}', true)">
                                Votaci√≥n con Nombres
                            </button>
                        </div>
                    ` : ''}
                    <div id="votacion_${punto.id}"></div>
                </div>
            `;

            // Cargar contenido inicial
            setTimeout(() => {
                cargarAportaciones(punto.id);
                cargarVotacion(punto.id);
                cargarDocumentos(punto.id);
            }, 100);

            // Listeners en tiempo real - SOLO SI NO EXISTEN YA
            if (!puntosListeners[punto.id]) {
                puntosListeners[punto.id] = {};
                
                // Listener para aportaciones
                const aportacionesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${punto.id}/aportaciones`);
                puntosListeners[punto.id].aportaciones = onValue(aportacionesRef, () => {
                    cargarAportaciones(punto.id);
                });

                // Listener para votaci√≥n
                const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${punto.id}/votacion`);
                puntosListeners[punto.id].votacion = onValue(votacionRef, () => {
                    cargarVotacion(punto.id);
                });

                // Listener para documentos
                const documentosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${punto.id}/documentos`);
                puntosListeners[punto.id].documentos = onValue(documentosRef, () => {
                    cargarDocumentos(punto.id);
                });
            }

            return card;
        };

        // Agregar aportaci√≥n
        window.agregarAportacion = async function(puntoId) {
            const input = document.getElementById('input_' + puntoId);
            const texto = input.value.trim();

            if (!texto) {
                alert('Escribe un comentario');
                return;
            }

            const aportacionesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/aportaciones`);
            const nuevaAportacionRef = push(aportacionesRef);

            await set(nuevaAportacionRef, {
                autor: window.usuarioActual.nombre,
                rol: window.usuarioActual.rol,
                texto: texto,
                timestamp: Date.now()
            });

            input.value = '';
        };

        // Cargar aportaciones (estilo WhatsApp)
        window.cargarAportaciones = async function(puntoId) {
            const contenedor = document.getElementById('aportaciones_' + puntoId);
            if (!contenedor) return;

            const aportacionesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/aportaciones`);
            
            try {
                const snapshot = await get(aportacionesRef);

                if (!snapshot.exists()) {
                    contenedor.innerHTML = '<div class="empty-state"><div class="emoji">üí≠</div><p>No hay comentarios a√∫n. ¬°S√© el primero!</p></div>';
                    return;
                }

                const aportaciones = snapshot.val();
                const aportacionesArray = Object.values(aportaciones);
                aportacionesArray.sort((a, b) => a.timestamp - b.timestamp);

                contenedor.innerHTML = '';
                
                aportacionesArray.forEach(aport => {
                    const div = document.createElement('div');
                    div.className = 'aportacion';
                    div.innerHTML = `
                        <div class="aportacion-header">
                            <span class="aportacion-autor">
                                ${aport.rol === 'coordinador' ? 'üëë' : 'üë§'} <strong>${aport.autor}</strong>
                            </span>
                            <span class="aportacion-hora">${new Date(aport.timestamp).toLocaleString('es-ES', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}</span>
                        </div>
                        <div class="aportacion-texto">${aport.texto}</div>
                    `;
                    contenedor.appendChild(div);
                });

                // Scroll autom√°tico al final (como WhatsApp)
                contenedor.scrollTop = contenedor.scrollHeight;
                
            } catch (error) {
                console.error('Error cargando aportaciones:', error);
                contenedor.innerHTML = '<div class="empty-state"><div class="emoji">‚ö†Ô∏è</div><p>Error cargando comentarios</p></div>';
            }
        };

        // Adjuntar documento
        window.adjuntarDocumento = async function(puntoId) {
            const nombreInput = document.getElementById('nombre_doc_' + puntoId);
            const linkInput = document.getElementById('link_doc_' + puntoId);
            
            const nombre = nombreInput.value.trim();
            const link = linkInput.value.trim();

            if (!nombre || !link) {
                alert('Por favor completa el nombre y el enlace del documento');
                return;
            }

            // Validar que es una URL
            try {
                new URL(link);
            } catch {
                alert('El enlace no es v√°lido. Aseg√∫rate de incluir https://');
                return;
            }

            const documentosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/documentos`);
            const nuevoDocumentoRef = push(documentosRef);

            await set(nuevoDocumentoRef, {
                nombre: nombre,
                link: link,
                autor: window.usuarioActual.nombre,
                timestamp: Date.now()
            });

            // Limpiar campos
            nombreInput.value = '';
            linkInput.value = '';
        };

        // Cargar documentos
        window.cargarDocumentos = async function(puntoId) {
            const contenedor = document.getElementById('documentos_' + puntoId);
            if (!contenedor) return;

            const documentosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/documentos`);
            
            try {
                const snapshot = await get(documentosRef);

                if (!snapshot.exists()) {
                    contenedor.innerHTML = '';
                    return;
                }

                const documentos = snapshot.val();
                const documentosArray = Object.values(documentos);
                documentosArray.sort((a, b) => a.timestamp - b.timestamp);

                contenedor.innerHTML = '<strong style="display: block; margin-bottom: 10px;">üìé Documentos adjuntos:</strong>';
                
                documentosArray.forEach(doc => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: var(--background); padding: 12px; border-radius: 8px; margin-bottom: 8px;';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                            <div style="flex: 1;">
                                <strong style="display: block; color: var(--primary); margin-bottom: 4px;">${doc.nombre}</strong>
                                <a href="${doc.link}" target="_blank" style="color: var(--secondary); font-size: 13px; word-break: break-all;">üîó Abrir enlace</a>
                                <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">
                                    Subido por ${doc.autor} ‚Ä¢ ${new Date(doc.timestamp).toLocaleString('es-ES', { 
                                        day: '2-digit', 
                                        month: '2-digit', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    })}
                                </div>
                            </div>
                        </div>
                    `;
                    contenedor.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error cargando documentos:', error);
            }
        };

        // Crear votaci√≥n
        window.crearVotacion = async function(puntoId, conNombres) {
            const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion`);
            
            await set(votacionRef, {
                activa: true,
                conNombres: conNombres,
                timestamp: Date.now()
            });
        };

        // Cargar votaci√≥n
        window.cargarVotacion = async function(puntoId) {
            const contenedor = document.getElementById('votacion_' + puntoId);
            if (!contenedor) return;

            const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion`);
            
            try {
                const snapshot = await get(votacionRef);

                if (!snapshot.exists() || !snapshot.val().activa) {
                    contenedor.innerHTML = '';
                    return;
                }

                const votacion = snapshot.val();
                const votos = votacion.votos || {};
                const miVoto = votos[window.usuarioActual.nombre];

                // Contar votos
                const conteo = { si: 0, no: 0, abstencion: 0 };
                Object.values(votos).forEach(v => {
                    conteo[v.voto]++;
                });
                const total = Object.keys(votos).length;

                contenedor.innerHTML = `
                    <div class="votacion-card">
                        <h3 style="margin-bottom: 10px;">${votacion.conNombres ? 'üó≥Ô∏è Votaci√≥n P√∫blica' : 'üîí Votaci√≥n An√≥nima'}</h3>
                        ${miVoto ? 
                            `<p style="margin-bottom: 15px;">Has votado: <strong>${miVoto.voto === 'si' ? '‚úÖ S√≠' : miVoto.voto === 'no' ? '‚ùå No' : '‚ö™ Abstenci√≥n'}</strong></p>` 
                            : '<p style="margin-bottom: 15px;">Emite tu voto:</p>'}
                        <div class="votacion-opciones">
                            <button class="voto-btn ${miVoto && miVoto.voto === 'si' ? 'selected' : ''}" 
                                onclick="votar('${puntoId}', 'si')" ${miVoto ? 'disabled' : ''}>
                                ‚úÖ S√≠
                            </button>
                            <button class="voto-btn ${miVoto && miVoto.voto === 'no' ? 'selected' : ''}" 
                                onclick="votar('${puntoId}', 'no')" ${miVoto ? 'disabled' : ''}>
                                ‚ùå No
                            </button>
                            <button class="voto-btn ${miVoto && miVoto.voto === 'abstencion' ? 'selected' : ''}" 
                                onclick="votar('${puntoId}', 'abstencion')" ${miVoto ? 'disabled' : ''}>
                                ‚ö™ Abstenci√≥n
                            </button>
                        </div>
                        ${window.usuarioActual.rol === 'coordinador' ? `
                            <button class="btn btn-danger btn-small" onclick="cerrarVotacion('${puntoId}')" style="margin-top: 10px; width: 100%;">
                                üîê Cerrar Votaci√≥n
                            </button>
                        ` : ''}
                        <div class="resultados-votacion">
                            <strong style="display: block; margin-bottom: 10px;">Resultados (${total} votos):</strong>
                            ${['si', 'no', 'abstencion'].map(tipo => {
                                const count = conteo[tipo];
                                const porcentaje = total > 0 ? Math.round((count / total) * 100) : 0;
                                const label = tipo === 'si' ? '‚úÖ S√≠' : tipo === 'no' ? '‚ùå No' : '‚ö™ Abstenci√≥n';
                                
                                let nombres = '';
                                if (votacion.conNombres) {
                                    const votantes = Object.entries(votos)
                                        .filter(([_, v]) => v.voto === tipo)
                                        .map(([nombre, _]) => nombre);
                                    if (votantes.length > 0) {
                                        nombres = `<div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">${votantes.join(', ')}</div>`;
                                    }
                                }
                                
                                return `
                                    <div class="resultado-item">
                                        <strong>${label}</strong>
                                        <div class="resultado-barra">
                                            <div class="resultado-progreso" style="width: ${porcentaje}%;">
                                                ${porcentaje}%
                                            </div>
                                        </div>
                                        <span>${count}</span>
                                    </div>
                                    ${nombres}
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando votaci√≥n:', error);
            }
        };

        // Votar
        window.votar = async function(puntoId, voto) {
            const votoRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion/votos/${window.usuarioActual.nombre}`);
            
            await set(votoRef, {
                nombre: window.usuarioActual.nombre,
                voto: voto,
                timestamp: Date.now()
            });
        };

        // Cerrar votaci√≥n
        window.cerrarVotacion = async function(puntoId) {
            if (!confirm('¬øCerrar la votaci√≥n? No se podr√°n a√±adir m√°s votos.')) {
                return;
            }
            
            const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion`);
            await update(votacionRef, { activa: false });
        };

        // Gesti√≥n de videollamada
        window.gestionarVideollamada = function() {
            const enlace = prompt('Introduce el enlace de la videollamada (Google Meet, Zoom, etc.):\n\nDeja vac√≠o para eliminar el enlace actual.');
            
            if (enlace === null) return; // Cancelado
            
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            
            if (enlace.trim() === '') {
                // Eliminar enlace
                remove(videollamadaRef);
            } else {
                // Guardar enlace
                set(videollamadaRef, {
                    enlace: enlace.trim(),
                    timestamp: Date.now()
                });
            }
        };

        // Cargar videollamada
        window.cargarVideollamada = async function() {
            const bannerContainer = document.getElementById('videollamadaBanner');
            const gestionContainer = document.getElementById('gestionVideollamada');
            
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            const snapshot = await get(videollamadaRef);
            
            // Bot√≥n de gesti√≥n para coordinador
            if (window.usuarioActual.rol === 'coordinador') {
                gestionContainer.innerHTML = `
                    <button class="btn btn-outline btn-small" onclick="gestionarVideollamada()" style="margin-bottom: 20px;">
                        üé• ${snapshot.exists() ? 'Editar' : 'A√±adir'} Enlace de Videollamada
                    </button>
                `;
            } else {
                gestionContainer.innerHTML = '';
            }
            
            // Banner de videollamada
            if (snapshot.exists()) {
                const videollamada = snapshot.val();
                bannerContainer.innerHTML = `
                    <div class="videollamada-banner">
                        <div class="videollamada-banner-content">
                            <div class="videollamada-icon">üé•</div>
                            <div class="videollamada-texto">
                                <strong>Videollamada Activa</strong>
                                <small>Haz clic para unirte a la reuni√≥n virtual</small>
                            </div>
                        </div>
                        <div class="videollamada-actions">
                            <a href="${videollamada.enlace}" target="_blank" class="btn-videollamada">
                                üöÄ Unirse
                            </a>
                        </div>
                    </div>
                `;
            } else {
                bannerContainer.innerHTML = '';
            }
        };

        // Exportar a PDF
        window.exportarPDF = async function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n
            let y = 20;
            const lineHeight = 7;
            const pageHeight = 280;
            
            // Funci√≥n para a√±adir nueva p√°gina si es necesario
            const checkPage = () => {
                if (y > pageHeight) {
                    doc.addPage();
                    y = 20;
                }
            };
            
            // Encabezado
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('CEIP Capitulaciones de Santa Fe', 20, y);
            y += 10;
            
            // Nombre de la reuni√≥n
            doc.setFontSize(14);
            const nombreReunion = getNombreReunion(window.sesionActual, window.fechaActual);
            doc.text(nombreReunion, 20, y);
            y += 10;
            
            // Obtener datos
            const sesionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}`);
            const snapshot = await get(sesionRef);
            
            if (!snapshot.exists()) {
                alert('No se pueden cargar los datos de la reuni√≥n');
                return;
            }
            
            const sesionData = snapshot.val();
            
            // Participantes
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Participantes:', 20, y);
            y += lineHeight;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            
            if (sesionData.participantes) {
                Object.values(sesionData.participantes).forEach(p => {
                    checkPage();
                    const emoji = p.rol === 'coordinador' ? '* ' : '- ';
                    doc.text(`${emoji}${p.nombre} (${p.rol})`, 25, y);
                    y += lineHeight;
                });
            }
            
            y += 5;
            
            // Orden del d√≠a
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            checkPage();
            doc.text('Orden del Dia:', 20, y);
            y += lineHeight + 2;
            
            if (sesionData.puntos) {
                const puntosArray = Object.entries(sesionData.puntos).map(([id, data]) => ({ id, ...data }));
                puntosArray.sort((a, b) => a.orden - b.orden);
                
                puntosArray.forEach((punto, index) => {
                    checkPage();
                    
                    // N√∫mero y t√≠tulo del punto
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${punto.texto}`, 20, y);
                    y += lineHeight;
                    
                    // Aportaciones
                    if (punto.aportaciones) {
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        
                        const aportacionesArray = Object.values(punto.aportaciones);
                        aportacionesArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        aportacionesArray.forEach(aport => {
                            checkPage();
                            const hora = new Date(aport.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                            doc.text(`   [${hora}] ${aport.autor}:`, 25, y);
                            y += lineHeight;
                            
                            // Dividir texto largo en l√≠neas
                            const maxWidth = 160;
                            const lineas = doc.splitTextToSize(`   ${aport.texto}`, maxWidth);
                            lineas.forEach(linea => {
                                checkPage();
                                doc.text(linea, 25, y);
                                y += lineHeight - 1;
                            });
                            y += 2;
                        });
                    }
                    
                    // Votaci√≥n
                    if (punto.votacion && punto.votacion.activa) {
                        checkPage();
                        doc.setFont(undefined, 'bold');
                        const tipoVotacion = punto.votacion.conNombres ? 'Votacion Publica' : 'Votacion Anonima';
                        doc.text(`   ${tipoVotacion}:`, 25, y);
                        y += lineHeight;
                        
                        doc.setFont(undefined, 'normal');
                        
                        const votos = { si: [], no: [], abstencion: [] };
                        let total = 0;
                        
                        if (punto.votacion.votos) {
                            Object.values(punto.votacion.votos).forEach(v => {
                                total++;
                                votos[v.voto].push(v.nombre);
                            });
                        }
                        
                        ['si', 'no', 'abstencion'].forEach(tipo => {
                            checkPage();
                            const count = votos[tipo].length;
                            const porcentaje = total > 0 ? Math.round((count / total) * 100) : 0;
                            const label = tipo === 'si' ? 'Si' : tipo === 'no' ? 'No' : 'Abstencion';
                            doc.text(`      ${label}: ${count} (${porcentaje}%)`, 25, y);
                            y += lineHeight;
                            
                            if (punto.votacion.conNombres && count > 0) {
                                const nombres = votos[tipo].join(', ');
                                const lineas = doc.splitTextToSize(`         ${nombres}`, 155);
                                lineas.forEach(linea => {
                                    checkPage();
                                    doc.text(linea, 25, y);
                                    y += lineHeight - 1;
                                });
                            }
                        });
                    }
                    
                    // Documentos adjuntos
                    if (punto.documentos) {
                        checkPage();
                        doc.setFont(undefined, 'bold');
                        doc.text('   Documentos adjuntos:', 25, y);
                        y += lineHeight;
                        
                        doc.setFont(undefined, 'normal');
                        
                        const documentosArray = Object.values(punto.documentos);
                        documentosArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        documentosArray.forEach(docum => {
                            checkPage();
                            doc.text(`      - ${docum.nombre}`, 25, y);
                            y += lineHeight;
                            
                            // Enlace del documento
                            doc.setTextColor(0, 0, 255);
                            const lineas = doc.splitTextToSize(`        ${docum.link}`, 155);
                            lineas.forEach(linea => {
                                checkPage();
                                doc.text(linea, 25, y);
                                y += lineHeight - 1;
                            });
                            doc.setTextColor(0, 0, 0);
                            
                            // Info del autor
                            const hora = new Date(docum.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                            doc.text(`        (Subido por ${docum.autor} a las ${hora})`, 25, y);
                            y += lineHeight + 1;
                        });
                    }
                    
                    y += 5;
                });
            } else {
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text('No hay puntos del orden del dia', 25, y);
                y += lineHeight;
            }
            
            // Guardar PDF
            const nombreArchivo = `Reunion_${window.sesionActual}_${window.fechaActual}.pdf`;
            doc.save(nombreArchivo);
        };

        // Salir de reuni√≥n
        window.salirDeReunion = function() {
            if (confirm('¬øSeguro que quieres salir de la reuni√≥n?')) {
                location.reload();
            }
        };

        // Cargar puntos en configuraci√≥n con listener en tiempo real
        const setupPuntosListener = () => {
            if (!window.sesionActual || !window.fechaActual) return;
            
            const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
            onValue(puntosRef, async (snapshot) => {
                const lista = document.getElementById('listaPuntos');
                if (!lista) return;
                
                lista.innerHTML = '';

                if (!snapshot.exists()) return;

                const puntos = snapshot.val();
                const puntosArray = Object.entries(puntos).map(([id, data]) => ({ id, ...data }));
                puntosArray.sort((a, b) => a.orden - b.orden);

                puntosArray.forEach(punto => {
                    const div = document.createElement('div');
                    div.className = 'punto-item';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">${punto.texto}</span>
                            <button class="btn btn-danger btn-small" onclick="eliminarPunto('${punto.id}')">‚ùå</button>
                        </div>
                    `;
                    lista.appendChild(div);
                });
            });
        };

        // Cuando se crea una sesi√≥n, configurar el listener
        const originalCrearSesion = window.crearSesion;
        window.crearSesion = function() {
            originalCrearSesion();
            setTimeout(setupPuntosListener, 500);
        };
    </script>

    <script>
        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw-teletrabajo.js');
        }
    </script>
</body>
</html>
