<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <meta name="description" content="App para reuniones telem√°ticas con orden del d√≠a y votaciones">
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Teletrabajo">
    
    <!-- iOS Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Teletrabajo">
    <link rel="apple-touch-icon" href="icon-180.png">
    
    <!-- Manifest y favicons -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    <title>Teletrabajo Capitulaciones</title>
    
    <!-- Librer√≠a para generar c√≥digos QR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --coordinador: #8b5cf6;
            --maestro: #06b6d4;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Banner t√≠tulo de reuni√≥n */
        .meeting-title-banner {
            background: rgba(255, 255, 255, 0.15);
            padding: 12px 20px;
            margin-top: 15px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text);
            font-size: 14px;
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Mejorar visibilidad del input de nombre en m√≥viles */
        #inputNombre {
            border: 3px solid var(--primary);
            background: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }

        #inputNombre::placeholder {
            color: #94a3b8;
            font-weight: 500;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .code-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .code-display .code {
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .code-display p {
            font-size: 14px;
            opacity: 0.95;
            margin-top: 10px;
        }

        .user-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 5px 5px 5px 0;
        }

        .user-badge.coordinador {
            background: rgba(139, 92, 246, 0.1);
            color: var(--coordinador);
            border: 2px solid var(--coordinador);
        }

        .user-badge.maestro {
            background: rgba(6, 182, 212, 0.1);
            color: var(--maestro);
            border: 2px solid var(--maestro);
        }

        .user-badge.familia {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 2px solid #22c55e;
        }

        .punto-item {
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .punto-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .punto-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }

        .punto-numero {
            background: var(--primary);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            flex-shrink: 0;
        }

        .punto-titulo {
            font-weight: 600;
            font-size: 16px;
            flex-grow: 1;
            padding: 0 15px;
        }

        .aportacion {
            background: white;
            border-left: 4px solid var(--secondary);
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: all 0.2s;
        }

        .aportacion:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
            transform: translateY(-1px);
        }

        .aportacion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .aportacion-autor {
            font-weight: 600;
            font-size: 14px;
            color: var(--primary);
        }

        .aportacion-hora {
            font-size: 11px;
            color: var(--text-light);
        }

        .aportacion-texto {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text);
            word-wrap: break-word;
            white-space: pre-wrap; /* Respeta saltos de l√≠nea y espacios */
        }

        .votacion-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin: 15px 0;
        }

        .votacion-opciones {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .voto-btn {
            padding: 15px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .voto-btn:hover,
        .voto-btn.selected {
            background: white;
            color: var(--primary);
            transform: scale(1.05);
        }

        .resultados-votacion {
            background: white;
            color: var(--text);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .resultado-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: var(--background);
            border-radius: 6px;
        }

        .resultado-barra {
            flex-grow: 1;
            height: 24px;
            background: var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin: 0 15px;
        }

        .resultado-progreso {
            height: 100%;
            background: var(--primary);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        .info-box {
            background: rgba(37, 99, 235, 0.1);
            border-left: 4px solid var(--primary);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
        }

        .empty-state .emoji {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .chat-container {
            background: var(--background);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: var(--background);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-light);
        }

        .session-info {
            background: var(--background);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-code {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .status-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--secondary);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .status-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .btn-group {
                grid-template-columns: 1fr;
            }

            .code-display .code {
                font-size: 36px;
                letter-spacing: 6px;
            }

            .votacion-opciones {
                grid-template-columns: 1fr;
            }

            .status-indicator {
                top: auto;
                bottom: 20px;
                right: 20px;
            }
        }

        /* Banner de videollamada */
        .videollamada-banner {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .videollamada-banner-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .videollamada-icon {
            font-size: 24px;
            animation: pulse 2s infinite;
        }

        .videollamada-texto {
            flex: 1;
        }

        .videollamada-texto strong {
            display: block;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .videollamada-texto small {
            opacity: 0.9;
            font-size: 13px;
        }

        .videollamada-actions {
            display: flex;
            gap: 8px;
        }

        .btn-videollamada {
            background: white;
            color: var(--primary);
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-videollamada:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-videollamada-edit {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.3);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .btn-videollamada-edit:hover {
            background: rgba(255,255,255,0.3);
        }

        @media (max-width: 768px) {
            .videollamada-banner {
                flex-direction: column;
                align-items: stretch;
            }

            .videollamada-actions {
                flex-direction: column;
            }

            .btn-videollamada {
                width: 100%;
            }
        }

        /* Chat lateral general */
        .chat-lateral {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 350px;
            max-height: calc(100vh - 120px);
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            z-index: 999;
            transition: transform 0.3s ease;
        }

        .chat-lateral.minimizado {
            transform: translateX(calc(100% - 60px));
        }

        .chat-lateral-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .chat-lateral-header h3 {
            font-size: 16px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-lateral-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .chat-lateral-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-lateral-mensajes {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: var(--background);
        }

        .chat-lateral-mensajes::-webkit-scrollbar {
            width: 6px;
        }

        .chat-lateral-mensajes::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .mensaje-general {
            background: white;
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .mensaje-general-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .mensaje-general-autor {
            font-weight: 600;
            font-size: 13px;
            color: var(--primary);
        }

        .mensaje-general-hora {
            font-size: 10px;
            color: var(--text-light);
        }

        .mensaje-general-texto {
            font-size: 14px;
            line-height: 1.4;
            color: var(--text);
            word-wrap: break-word;
        }

        .chat-lateral-input {
            padding: 12px;
            background: white;
            border-top: 1px solid var(--border);
            border-radius: 0 0 12px 12px;
        }

        .chat-lateral-input-group {
            display: flex;
            gap: 8px;
        }

        .chat-lateral-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .chat-lateral-input input:focus {
            border-color: var(--primary);
        }

        .chat-lateral-input button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--primary);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .chat-lateral-input button:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .chat-badge {
            background: var(--danger);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        @media (max-width: 1200px) {
            .chat-lateral {
                width: 300px;
            }
        }

        @media (max-width: 768px) {
            .chat-lateral {
                right: 0;
                left: 0;
                top: auto;
                bottom: 0;
                width: 100%;
                max-height: 60vh;
                border-radius: 12px 12px 0 0;
            }

            .chat-lateral.minimizado {
                transform: translateY(calc(100% - 60px));
            }

            .chat-lateral-header {
                border-radius: 12px 12px 0 0;
            }
        }

        /* Ajustar contenedor principal cuando est√° el chat */
        .container.con-chat {
            margin-right: 370px;
        }

        @media (max-width: 1200px) {
            .container.con-chat {
                margin-right: 320px;
            }
        }

        @media (max-width: 768px) {
            .container.con-chat {
                margin-right: 0;
                padding-bottom: 100px;
            }
        }

        /* Bot√≥n de instalaci√≥n */
        .install-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
            transition: all 0.3s;
            animation: pulse-install 2s infinite;
        }

        .install-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .install-button.hidden {
            display: none;
        }

        @keyframes pulse-install {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
            }
            50% {
                box-shadow: 0 4px 20px rgba(16, 185, 129, 0.6);
            }
        }

        /* Modal de instrucciones iOS */
        .ios-install-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            padding: 20px;
        }

        .ios-install-modal.active {
            display: flex;
        }

        .ios-install-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .ios-install-content h3 {
            margin: 0 0 20px 0;
            color: var(--primary);
            font-size: 20px;
            text-align: center;
        }

        .ios-install-step {
            display: flex;
            align-items: start;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--background);
            border-radius: 8px;
        }

        .ios-install-step-number {
            background: var(--primary);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            margin-right: 12px;
        }

        .ios-install-step-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .install-button {
                bottom: 10px;
                left: 10px;
                font-size: 13px;
                padding: 10px 16px;
            }
        }

        /* Modal de Citaci√≥n con QR */
        .citacion-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
            padding: 20px;
            overflow-y: auto;
        }

        .citacion-modal.active {
            display: flex;
        }

        .citacion-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .citacion-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .citacion-header h2 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .citacion-header p {
            margin: 5px 0;
            opacity: 0.95;
            font-size: 16px;
        }

        .citacion-body {
            padding: 30px;
        }

        .citacion-section {
            margin-bottom: 25px;
        }

        .citacion-section h3 {
            color: var(--primary);
            font-size: 18px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .citacion-section ul {
            list-style: none;
            padding: 0;
        }

        .citacion-section li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }

        .citacion-section li:before {
            content: "‚ñ∏";
            position: absolute;
            left: 5px;
            color: var(--primary);
            font-weight: bold;
        }

        .qr-container {
            text-align: center;
            padding: 20px;
            background: var(--background);
            border-radius: 12px;
            margin: 20px 0;
        }

        .qr-container h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
        }

        #qrcode {
            display: inline-block;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .qr-instructions {
            margin-top: 15px;
            color: var(--text-light);
            font-size: 14px;
            line-height: 1.6;
        }

        .citacion-footer {
            padding: 20px 30px;
            background: var(--background);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .citacion-footer button {
            flex: 1;
            min-width: 140px;
        }

        @media (max-width: 768px) {
            .citacion-header {
                padding: 20px;
            }

            .citacion-header h2 {
                font-size: 20px;
            }

            .citacion-body {
                padding: 20px;
            }

            .citacion-footer {
                padding: 15px 20px;
            }

            .citacion-footer button {
                min-width: 100%;
            }
        }

        /* Bot√≥n de ayuda en p√°gina principal */
        .help-btn-inline {
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 0;
            transition: all 0.2s;
            position: relative;
        }

        .help-btn-inline:hover {
            transform: scale(1.1);
        }

        .help-btn-inline .icon {
            width: 40px;
            height: 40px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
        }

        .help-btn-inline .label {
            font-size: 12px;
            color: var(--text);
            font-weight: 600;
        }

        .help-btn-inline[data-tooltip-help]:hover::before {
            content: attr(data-tooltip-help);
            position: absolute;
            top: 60px;
            right: -50px;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
        }

        .card-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Dropdown para descargar acta */
        .acta-dropdown {
            position: relative;
            display: inline-block;
        }

        .acta-dropdown-content {
            display: none;
            position: absolute;
            bottom: 100%;
            right: 0;
            background: white;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            z-index: 1000;
            margin-bottom: 8px;
            overflow: hidden;
        }

        .acta-dropdown.active .acta-dropdown-content {
            display: block;
        }

        .acta-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border: none;
            background: white;
            width: 100%;
            text-align: left;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
            position: relative;
        }

        .acta-dropdown-item:hover {
            background: var(--background);
        }

        .acta-dropdown-item:not(:last-child) {
            border-bottom: 1px solid var(--border);
        }

        .acta-dropdown-item[data-acta-tooltip]:hover::after {
            content: attr(data-acta-tooltip);
            position: absolute;
            left: -220px;
            top: 50%;
            transform: translateY(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 2000;
        }

        .acta-dropdown-item[data-acta-tooltip]:hover::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-left-color: #333;
            z-index: 2000;
        }

        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .help-modal.active {
            display: flex;
        }

        .help-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .help-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .help-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .help-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .help-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .help-tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            background: var(--background);
        }

        .help-tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-light);
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .help-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: white;
        }

        .help-tab:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .help-tab-content {
            display: none;
            padding: 25px;
        }

        .help-tab-content.active {
            display: block;
        }

        .help-section {
            margin-bottom: 25px;
        }

        .help-section h3 {
            color: var(--primary);
            font-size: 18px;
            margin-bottom: 10px;
        }

        .help-step {
            background: var(--background);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid var(--primary);
        }

        .help-step strong {
            color: var(--primary);
        }

        .help-important {
            background: rgba(245, 158, 11, 0.1);
            border-left: 4px solid var(--warning);
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .help-important strong {
            color: var(--warning);
        }

        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            cursor: help;
            margin-left: 5px;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            font-weight: normal;
        }

        .tooltip:hover::before {
            content: '';
            position: absolute;
            bottom: 115%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #333;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .help-content {
                max-height: 85vh;
            }

            .help-tabs {
                flex-direction: column;
            }

            .help-tab {
                border-bottom: 1px solid var(--border);
            }

            .tooltip:hover::after {
                white-space: normal;
                max-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìã Teletrabajo Capitulaciones</h1>
        <div class="subtitle">CEIP Capitulaciones de Santa Fe</div>
        <!-- T√≠tulo de la reuni√≥n (se mostrar√° din√°micamente) -->
        <div id="meetingTitleBanner" class="meeting-title-banner" style="display: none;"></div>
    </div>

    <div class="status-indicator" id="statusIndicator" style="display: none;">
        Conectado en tiempo real
    </div>

    <!-- Bot√≥n de instalaci√≥n -->
    <button id="installButton" class="install-button hidden">
        üì± Instalar App
    </button>

    <!-- Modal de ayuda -->
    <div id="helpModal" class="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2>‚ùì C√≥mo usar la aplicaci√≥n</h2>
                <button class="help-close" onclick="toggleHelpModal()">√ó</button>
            </div>
            
            <div class="help-tabs">
                <button class="help-tab active" onclick="switchHelpTab('coordinador')">
                    üëî Coordinador
                </button>
                <button class="help-tab" onclick="switchHelpTab('maestro')">
                    üë®‚Äçüè´ Maestro
                </button>
                <button class="help-tab" onclick="switchHelpTab('infografia')">
                    üìä Infograf√≠a
                </button>
            </div>
            
            <div id="helpCoordinador" class="help-tab-content active">
                <div class="help-section">
                    <h3>1Ô∏è‚É£ Crear la Reuni√≥n</h3>
                    <div class="help-step">
                        <strong>Paso 1:</strong> Introduce tu nombre y selecciona "Coordinador" como rol
                    </div>
                    <div class="help-step">
                        <strong>Paso 2:</strong> Elige el tipo de reuni√≥n y la fecha
                    </div>
                    <div class="help-step">
                        <strong>Paso 3:</strong> Clic en "Crear Reuni√≥n"
                    </div>
                    <div class="help-important">
                        <strong>‚ö†Ô∏è IMPORTANTE:</strong> Antes de iniciar la reuni√≥n, crea todos los puntos del orden del d√≠a. Despu√©s haz clic en "Iniciar Reuni√≥n".
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>2Ô∏è‚É£ Compartir el Acceso</h3>
                    <div class="help-step">
                        <strong>Enlace web directo:</strong> Al generar la citaci√≥n, aparece autom√°ticamente un enlace que puedes copiar y compartir por WhatsApp, Email, etc. Usa el bot√≥n de compartir (‚ö™‚ö™‚ö™) junto al enlace.
                    </div>
                    <div class="help-step">
                        <strong>C√≥digo QR:</strong> Los maestros escanean el c√≥digo QR para entrar directamente.
                    </div>
                    <div class="help-important">
                        <strong>üí° CONSEJO:</strong> El enlace web es m√°s pr√°ctico que el QR. Aparece autom√°ticamente junto al c√≥digo QR.
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>3Ô∏è‚É£ Durante la Reuni√≥n</h3>
                    <div class="help-step">
                        <strong>üìé Documentos:</strong> Adjunta documentos con enlace de Google Drive. Bot√≥n de compartir (icono ‚ö™‚ö™‚ö™) y bot√≥n de eliminar (üóëÔ∏è)
                    </div>
                    <div class="help-step">
                        <strong>üí¨ Aportaciones:</strong> Puedes editar y borrar TODAS las aportaciones (tuyas y de los maestros)
                    </div>
                    <div class="help-step">
                        <strong>üë• Participantes:</strong> Elimina participantes duplicados con el bot√≥n üóëÔ∏è
                    </div>
                    <div class="help-step">
                        <strong>üó≥Ô∏è Votaciones:</strong> Crea votaciones y ve resultados en tiempo real
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>4Ô∏è‚É£ Exportar el Acta</h3>
                    <div class="help-step">
                        <strong>üìÑ PDF:</strong> Descarga el acta en PDF
                    </div>
                    <div class="help-step">
                        <strong>üìß Email:</strong> Abre tu correo con el acta lista para enviar
                    </div>
                    <div class="help-step">
                        <strong>üìã Copiar:</strong> Copia el acta al portapapeles para pegarla donde quieras
                    </div>
                </div>
            </div>
            
            <div id="helpMaestro" class="help-tab-content">
                <div class="help-section">
                    <h3>1Ô∏è‚É£ Unirse a la Reuni√≥n</h3>
                    <div class="help-step">
                        <strong>Opci√≥n 1 - Enlace web (RECOMENDADO):</strong> El coordinador te env√≠a un enlace. Haces clic, introduces tu nombre y entras.
                    </div>
                    <div class="help-step">
                        <strong>Opci√≥n 2 - C√≥digo QR:</strong> Escanea el QR con la c√°mara del m√≥vil, introduces tu nombre y entras.
                    </div>
                    <div class="help-step">
                        <strong>Opci√≥n 3 - Manual:</strong> Introduce tu nombre, selecciona "Maestro", elige la reuni√≥n y fecha, clic en "Unirse a Reuni√≥n"
                    </div>
                </div>
                
                <div class="help-section">
                    <h3>2Ô∏è‚É£ Durante la Reuni√≥n</h3>
                    <div class="help-step">
                        <strong>üí¨ Conversaci√≥n:</strong> Escribe comentarios en cada punto. Puedes editar y borrar solo TUS comentarios.
                    </div>
                    <div class="help-step">
                        <strong>üó≥Ô∏è Votar:</strong> Vota A favor / En contra / Abstenci√≥n. Puedes cambiar tu voto mientras est√© activa.
                    </div>
                    <div class="help-step">
                        <strong>üìé Documentos:</strong> Ve y comparte los documentos que suba el coordinador (bot√≥n ‚ö™‚ö™‚ö™)
                    </div>
                    <div class="help-step">
                        <strong>üé• Videollamada:</strong> Si hay enlace de videollamada, ver√°s un banner azul arriba. Haz clic para entrar.
                    </div>
                    <div class="help-important">
                        <strong>‚ö†Ô∏è IMPORTANTE:</strong> Para enviar mensajes, escribe y haz clic en el bot√≥n "Enviar". La tecla Enter NO env√≠a el mensaje.
                    </div>
                </div>
            </div>
            
            <div id="helpInfografia" class="help-tab-content">
                <div class="help-section">
                    <h3>üìä Gu√≠a Visual Completa</h3>
                    <p style="margin-bottom: 15px;">Haz clic en la imagen para verla en tama√±o completo:</p>
                    <div style="text-align: center;">
                        <img src="infografia-reunion.jpg" 
                             alt="Gu√≠a R√°pida de Reuniones" 
                             style="max-width: 100%; height: auto; cursor: pointer; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"
                             onclick="abrirInfografiaVentana()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de instrucciones para iOS -->
    <div id="iosInstallModal" class="ios-install-modal">
        <div class="ios-install-content">
            <h3>üì± Instalar en iPhone/iPad</h3>
            <div class="ios-install-step">
                <div class="ios-install-step-number">1</div>
                <div class="ios-install-step-text">
                    Pulsa el bot√≥n de <strong>Compartir</strong> 
                    <svg style="display: inline; width: 20px; height: 20px; vertical-align: middle;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13"/>
                    </svg>
                    (cuadrado con flecha hacia arriba)
                </div>
            </div>
            <div class="ios-install-step">
                <div class="ios-install-step-number">2</div>
                <div class="ios-install-step-text">
                    Despl√°zate y selecciona <strong>"A√±adir a pantalla de inicio"</strong>
                </div>
            </div>
            <div class="ios-install-step">
                <div class="ios-install-step-number">3</div>
                <div class="ios-install-step-text">
                    Pulsa <strong>"A√±adir"</strong> en la esquina superior derecha
                </div>
            </div>
            <button class="btn btn-primary" onclick="cerrarModalIOS()" style="margin-top: 20px;">
                ‚úÖ Entendido
            </button>
        </div>
    </div>

    <!-- Modal de Citaci√≥n con QR -->
    <div id="citacionModal" class="citacion-modal">
        <div class="citacion-content">
            <div class="citacion-header">
                <h2>üìã CONVOCATORIA DE REUNI√ìN</h2>
                <p><strong>CEIP Capitulaciones de Santa Fe</strong></p>
                <p id="citacion-tipo-reunion"></p>
                <p id="citacion-fecha-reunion"></p>
            </div>
            
            <div class="citacion-body">
                <div class="citacion-section">
                    <h3>üìå Orden del D√≠a</h3>
                    <ul id="citacion-orden-dia"></ul>
                </div>

                <div class="citacion-section" id="citacion-videollamadas-section" style="display: none;">
                    <h3>üé• Enlaces de Videollamada</h3>
                    <div id="citacion-videollamadas"></div>
                </div>

                <div class="qr-container">
                    <h3>üì± Acceso R√°pido</h3>
                    <div id="qrcode"></div>
                    <div class="qr-instructions">
                        <strong>Escanea este c√≥digo QR con tu m√≥vil</strong><br>
                        para unirte directamente a la reuni√≥n
                    </div>
                    
                    <!-- Enlace directo con bot√≥n compartir -->
                    <div style="margin-top: 20px; padding: 15px; background: rgba(37, 99, 235, 0.05); border-radius: 8px; border: 1px solid rgba(37, 99, 235, 0.2);">
                        <strong style="display: block; margin-bottom: 8px; color: var(--primary);">üîó Enlace directo:</strong>
                        <input type="text" id="enlaceReunionMostrado" readonly 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 13px; background: white; font-family: monospace; margin-bottom: 10px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="copiarEnlaceReunion()" 
                                    style="flex: 1; background: var(--success); color: white; border: none; border-radius: 6px; padding: 10px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;" 
                                    title="Copiar enlace al portapapeles">
                                üìã Copiar Enlace
                            </button>
                            <button onclick="compartirEnlaceReunion()" 
                                    style="background: var(--primary); color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 8px; flex-shrink: 0;" 
                                    title="Compartir enlace">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Enlace para familias (solo Consejo Escolar) -->
                    <div id="enlaceFamiliasSection" style="display: none; margin-top: 15px; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 2px solid rgba(139, 92, 246, 0.3);">
                        <strong style="display: block; margin-bottom: 8px; color: #8b5cf6;">üë®‚Äçüë©‚Äçüëß Enlace para FAMILIAS:</strong>
                        <p style="font-size: 12px; color: var(--text-light); margin-bottom: 10px;">Este enlace especial es para invitar a representantes de familias. Solo podr√°n ver esta reuni√≥n.</p>
                        <input type="text" id="enlaceFamiliasMostrado" readonly 
                               style="width: 100%; padding: 10px; border: 1px solid #8b5cf6; border-radius: 6px; font-size: 13px; background: white; font-family: monospace; margin-bottom: 10px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="copiarEnlaceFamilias()" 
                                    style="flex: 1; background: #8b5cf6; color: white; border: none; border-radius: 6px; padding: 10px; cursor: pointer; font-size: 14px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;" 
                                    title="Copiar enlace para familias">
                                üìã Copiar Enlace Familias
                            </button>
                            <button onclick="compartirEnlaceFamilias()" 
                                    style="background: #8b5cf6; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 8px; flex-shrink: 0;" 
                                    title="Compartir enlace para familias">
                                <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                    <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="citacion-footer">
                <button class="btn btn-primary" onclick="descargarQR()">
                    ‚¨áÔ∏è Descargar QR
                </button>
                <button class="btn btn-success" onclick="compartirCitacion()">
                    üì§ Compartir
                </button>
                <button class="btn btn-outline" onclick="cerrarCitacion()">
                    ‚ùå Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Pantalla de inicio -->
    <div id="screenInicio" class="screen active">
        <div class="container">
            <div class="card">
                <div class="card-header-row">
                    <h2 style="margin: 0;">Bienvenido</h2>
                    <button class="help-btn-inline" onclick="toggleHelpModal()" data-tooltip-help="Pasos para quien no tenga ni idea de c√≥mo funciona esto">
                        <div class="icon">?</div>
                        <div class="label">Ayuda</div>
                    </button>
                </div>
                <div class="form-group">
                    <label>
                        Tu nombre:
                        <span class="tooltip" data-tooltip="Este nombre aparecer√° en todas tus aportaciones">?</span>
                    </label>
                    <input type="text" id="inputNombre" placeholder="Ej: Mar√≠a Garc√≠a">
                </div>
                <div class="form-group">
                    <label>
                        Tu rol:
                        <span class="tooltip" data-tooltip="Coordinador: crea y gestiona la reuni√≥n. Maestro: participa en la reuni√≥n">?</span>
                    </label>
                    <select id="selectRol">
                        <option value="maestro">Maestro/a</option>
                        <option value="coordinador">Coordinador/a</option>
                    </select>
                </div>
            </div>

            <div class="card">
                <h2>Seleccionar Reuni√≥n</h2>
                <div class="form-group">
                    <label>Curso / Ciclo / Equipo / √ìrgano Colegiado:</label>
                    <select id="selectReunion">
                        <option value="">-- Selecciona --</option>
                        <optgroup label="üé® Educaci√≥n Infantil">
                            <option value="infantil-3">Infantil 3 a√±os</option>
                            <option value="infantil-4">Infantil 4 a√±os</option>
                            <option value="infantil-5">Infantil 5 a√±os</option>
                        </optgroup>
                        <optgroup label="üìö Educaci√≥n Primaria">
                            <option value="primero">1¬∫ de Primaria</option>
                            <option value="segundo">2¬∫ de Primaria</option>
                            <option value="tercero">3¬∫ de Primaria</option>
                            <option value="cuarto">4¬∫ de Primaria</option>
                            <option value="quinto">5¬∫ de Primaria</option>
                            <option value="sexto">6¬∫ de Primaria</option>
                        </optgroup>
                        <optgroup label="üîÑ Ciclos">
                            <option value="ciclo-infantil">Ciclo Infantil</option>
                            <option value="primer-ciclo">Primer Ciclo Primaria (1¬∫-2¬∫)</option>
                            <option value="segundo-ciclo">Segundo Ciclo Primaria (3¬∫-4¬∫)</option>
                            <option value="tercer-ciclo">Tercer Ciclo Primaria (5¬∫-6¬∫)</option>
                        </optgroup>
                        <optgroup label="üë• Equipos y Aulas">
                            <option value="orientacion">Equipo de Orientaci√≥n</option>
                            <option value="aula-tea">Aula TEA</option>
                        </optgroup>
                        <optgroup label="üèõÔ∏è √ìrganos Colegiados">
                            <option value="claustro">Claustro</option>
                            <option value="etcp">ETCP (Equipo T√©cnico de Coordinaci√≥n Pedag√≥gica)</option>
                            <option value="consejo-escolar">Consejo Escolar</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fecha de la reuni√≥n:</label>
                    <input type="date" id="inputFecha" value="">
                </div>
                <div class="info-box">
                    ‚ÑπÔ∏è <strong>Coordinador:</strong> Crea una nueva reuni√≥n con la fecha indicada<br>
                    ‚ÑπÔ∏è <strong>Maestro:</strong> √önete a la reuni√≥n existente (debe estar creada por el coordinador)<br>
                    ‚ÑπÔ∏è Las actas se borrar√°n al crear otra reuni√≥n de ese equipo en fecha diferente
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="crearSesion()">
                        ‚ûï Crear Reuni√≥n
                    </button>
                    <button class="btn btn-secondary" onclick="unirseASesion()">
                        üöÄ Unirse a Reuni√≥n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantalla de configuraci√≥n (solo coordinador) -->
    <div id="screenConfig" class="screen">
        <div class="container">
            <div class="code-display">
                <div>Reuni√≥n de:</div>
                <div class="code" id="nombreReunion" style="font-size: 32px; letter-spacing: 2px;">------</div>
                <p>Los participantes deben seleccionar la misma opci√≥n para unirse</p>
            </div>

            <div class="card">
                <h2>Orden del D√≠a</h2>
                <div class="info-box">
                    ‚ÑπÔ∏è Los puntos se cargan autom√°ticamente seg√∫n el tipo de reuni√≥n y la fecha seleccionada.<br>
                    Puedes eliminar puntos o a√±adir otros nuevos seg√∫n tus necesidades.
                </div>
                <div id="listaPuntos"></div>
                <div class="form-group">
                    <label>Nuevo punto del orden del d√≠a:</label>
                    <input type="text" id="inputNuevoPunto" placeholder="Ej: Revisi√≥n de objetivos del trimestre">
                </div>
                <button class="btn btn-secondary" onclick="agregarPunto()">
                    ‚ûï Agregar Punto
                </button>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="generarCitacion()" style="flex: 1; min-width: 200px;">
                    üîó Generar Enlaces de la Reuni√≥n
                </button>
                <button class="btn btn-primary" onclick="iniciarReunion()" style="flex: 1; min-width: 200px;">
                    üöÄ Iniciar Reuni√≥n
                </button>
            </div>
        </div>
    </div>

    <!-- Pantalla de reuni√≥n -->
    <div id="screenReunion" class="screen">
        <div class="container" id="containerReunion">
            <div class="session-info">
                <div>
                    <strong>Reuni√≥n:</strong> <span class="session-code" id="nombreActual" style="font-size: 16px;"></span>
                </div>
                <div style="display: flex; gap: 10px;">
                    <div class="acta-dropdown" id="actaDropdown">
                        <button class="btn btn-secondary btn-small" onclick="toggleActaDropdown()">
                            üìÑ Descargar el Acta
                        </button>
                        <div class="acta-dropdown-content">
                            <button class="acta-dropdown-item" onclick="exportarPDF(); closeActaDropdown();" data-acta-tooltip="Descarga el acta en formato PDF">
                                üìÑ Exportar PDF
                            </button>
                            <button class="acta-dropdown-item" onclick="enviarPorEmail(); closeActaDropdown();" data-acta-tooltip="Abre tu correo con el acta lista">
                                üìß Enviar por Email
                            </button>
                            <button class="acta-dropdown-item" onclick="copiarActa(); closeActaDropdown();" data-acta-tooltip="Copia el acta al portapapeles">
                                üìã Copiar al Portapapeles
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="salirDeReunion()">
                        üö™ Salir
                    </button>
                </div>
            </div>

            <!-- Banner de videollamada -->
            <div id="videollamadaBanner"></div>

            <!-- Bot√≥n para gestionar videollamada (solo coordinador) -->
            <div id="gestionVideollamada"></div>

            <div class="card">
                <h2>Participantes <span id="numParticipantes"></span></h2>
                <div id="listaParticipantes"></div>
            </div>

            <div id="contenidoPuntos"></div>
        </div>

        <!-- Chat lateral general -->
        <div class="chat-lateral" id="chatLateral">
            <div class="chat-lateral-header" onclick="toggleChatLateral()">
                <h3>
                    üí¨ Chat General
                    <span class="chat-badge" id="chatBadge" style="display: none;">0</span>
                </h3>
                <button class="chat-lateral-toggle" id="chatToggle">‚àí</button>
            </div>
            <div class="chat-lateral-mensajes" id="mensajesGenerales"></div>
            <div class="chat-lateral-input">
                <div class="chat-lateral-input-group">
                    <input type="text" id="inputChatGeneral" placeholder="Escribe un mensaje...">
                    <button onclick="enviarMensajeGeneral()">üì§</button>
                </div>
            </div>
        </div>
    </div>

    <!-- jsPDF para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, remove, get, update, onChildAdded, onChildChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDchcaSp2M8uRZxMbMG7sop_ypkZP7w8CI",
            authDomain: "teletrabajo-capitulaciones.firebaseapp.com",
            databaseURL: "https://teletrabajo-capitulaciones-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "teletrabajo-capitulaciones",
            storageBucket: "teletrabajo-capitulaciones.firebasestorage.app",
            messagingSenderId: "227282426388",
            appId: "1:227282426388:web:2e1e4a600d069f60b8a501"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Variables globales
        let sesionActual = null;
        let usuarioActual = null;
        let fechaActual = null;
        let puntosListenerActivo = false;
        let listenersPorPunto = new Map(); // Mapa para rastrear listeners por punto

        // Exponer funciones al scope global
        window.database = database;
        window.ref = ref;
        window.set = set;
        window.push = push;
        window.onValue = onValue;
        window.remove = remove;
        window.get = get;
        window.update = update;
        window.onChildAdded = onChildAdded;
        window.onChildChanged = onChildChanged;
        
        window.sesionActual = null;
        window.usuarioActual = null;
        window.fechaActual = null;
        window.ordenDia = []; // Array con los textos de los puntos del orden del d√≠a

        // √ìRDENES DEL D√çA PREDEFINIDOS POR √ìRGANO Y MES
        const ordenDelDiaPredefinido = {
            "EQUIPOS DOCENTES": {
                "09": ["Lectura y aprobaci√≥n del acta anterior", "Constituci√≥n del equipo docente", "Coordinaci√≥n vertical con miembros de otros equipos docentes si fuera necesario", "Elaboraci√≥n de la informaci√≥n para familias (normas del centro, objetivos, criterios de evaluaci√≥n)", "Evaluaci√≥n inicial", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "10": ["Lectura y aprobaci√≥n del acta anterior", "Detecci√≥n de dificultades de aprendizaje", "Propuesta de alumnado para refuerzo educativo", "An√°lisis del clima inicial de convivencia", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "11": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento del alumnado y de los planes de refuerzo", "Tratamiento de conflictos y estrategias de resoluci√≥n", "Evaluaci√≥n global del proceso de ense√±anza-aprendizaje", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "12": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n del alumnado en todas las √°reas", "Evaluaci√≥n de programas de refuerzo aplicados", "Evaluaci√≥n del clima de convivencia", "An√°lisis del grado de adecuaci√≥n curricular", "Evaluaci√≥n del funcionamiento del equipo docente", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "01": ["Lectura y aprobaci√≥n del acta anterior", "Revisi√≥n de propuestas de alumnado con refuerzo seg√∫n 1¬™ evaluaci√≥n", "Seguimiento global del grupo", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "02": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento global del grupo", "Revisi√≥n de alumnado en refuerzo", "Revisi√≥n del clima de convivencia", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "03": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n de alumnado en todas las √°reas", "Evaluaci√≥n de programas de refuerzo y medidas pertinentes", "Evaluaci√≥n del clima de convivencia", "Previsi√≥n de repetidores para comunicar a familias", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "04": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n del grupo aula", "Seguimiento de planes de refuerzo seg√∫n segunda evaluaci√≥n", "Remisi√≥n de nuevas propuestas al equipo de orientaci√≥n", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "05": ["Lectura y aprobaci√≥n del acta anterior", "Revisi√≥n del rendimiento del alumnado en refuerzo", "Revisi√≥n del clima de convivencia", "Propuesta de alumnado que no promociona al finalizar ciclo", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"],
                "06": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n final del alumnado y competencias clave", "An√°lisis de adecuaci√≥n curricular", "Propuestas de mejora de los distintos aspectos evaluados", "Coordinaci√≥n vertical con otros equipos docentes", "Seguimiento del alumnado y medidas propuestas", "Ruegos y preguntas"]
            },
            "EQUIPOS DE CICLO": {
                "09": ["Lectura y aprobaci√≥n del acta anterior", "Revisi√≥n y actualizaci√≥n de criterios de evaluaci√≥n y promoci√≥n", "Unificaci√≥n de criterios en lectoescritura y coordinaci√≥n con ETCP", "Organizaci√≥n de actividades complementarias con criterios pedag√≥gicos", "Planificaci√≥n de reuniones con familias", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "10": ["Lectura y aprobaci√≥n del acta anterior", "Colaborar con el equipo directivo en la actualizaci√≥n del Proyecto Educativo", "Elaborar programaciones did√°cticas o propuestas pedag√≥gicas", "Organizar actividades complementarias y extraescolares", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "11": ["Lectura y aprobaci√≥n del acta anterior", "Revisi√≥n metodol√≥gica y mejora de la acci√≥n tutorial", "Planificaci√≥n de actividades del D√≠a de los Derechos de la Infancia y D√≠a contra la Violencia Machista", "Planificaci√≥n del D√≠a de la Constituci√≥n y Navidad", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "12": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n de la pr√°ctica docente y ajuste metodol√≥gico", "Evaluaci√≥n del rendimiento del alumnado", "Evaluaci√≥n de las medidas de atenci√≥n a la diversidad", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "01": ["Lectura y aprobaci√≥n del acta anterior", "Revisi√≥n de actividades complementarias del segundo trimestre", "Planificaci√≥n del D√≠a de la Paz y la No Violencia", "Valoraci√≥n del clima de aula por ciclo", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "02": ["Lectura y aprobaci√≥n del acta anterior", "Planificaci√≥n de actividades del D√≠a de Andaluc√≠a y Carnaval", "Actividades del D√≠a de la Mujer Trabajadora", "Seguimiento del alumnado con dificultades", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "03": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n del rendimiento en el segundo trimestre", "Revisi√≥n de medidas de atenci√≥n a la diversidad", "Planificaci√≥n del D√≠a del Libro", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "04": ["Lectura y aprobaci√≥n del acta anterior", "An√°lisis de resultados de la segunda evaluaci√≥n", "Propuestas de mejora del rendimiento acad√©mico", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "05": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento de posibles repetidores", "Planificaci√≥n de actividades de fin de curso", "Seguimiento de las programaciones", "Ruegos y preguntas"],
                "06": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n final y propuestas de mejora para el siguiente curso", "Seguimiento de las programaciones", "Ruegos y preguntas"]
            },
            "ETCP": {
                "09": ["Lectura y aprobaci√≥n del acta anterior", "Informaci√≥n sobre calendario de reuniones", "Establecer criterios para revisi√≥n de programaciones y propuestas pedag√≥gicas", "Informar sobre medidas y programas de atenci√≥n a la diversidad (Protocolo NEAE)", "Ruegos y preguntas"],
                "10": ["Lectura y aprobaci√≥n del acta anterior", "Organizar el Plan de Formaci√≥n en Centros (CEP)", "Elaboraci√≥n del Plan de Mejora", "Propuesta de actividades para Halloween y D√≠a contra la Violencia Machista", "Informar sobre criterios de evaluaci√≥n y promoci√≥n", "Ruegos y preguntas"],
                "11": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento del Plan de Refuerzo con el Equipo de Orientaci√≥n", "Coordinaci√≥n con el Plan de Formaci√≥n en Centros", "Planificaci√≥n de actividades del D√≠a de la Constituci√≥n", "Elaboraci√≥n del calendario de sesiones de evaluaci√≥n", "Ruegos y preguntas"],
                "12": ["Lectura y aprobaci√≥n del acta anterior", "Supervisi√≥n de la aplicaci√≥n del Plan de Convivencia", "Revisi√≥n de medidas de atenci√≥n a la diversidad y refuerzo educativo", "Evaluaci√≥n del trimestre", "Ruegos y preguntas"],
                "01": ["Lectura y aprobaci√≥n del acta anterior", "Planificaci√≥n del D√≠a de la Paz y la No Violencia", "Planificaci√≥n de actividades de febrero (Carnaval, D√≠a de Andaluc√≠a)", "An√°lisis de resultados de la primera evaluaci√≥n", "Seguimiento del Plan de Mejora", "Ruegos y preguntas"],
                "02": ["Lectura y aprobaci√≥n del acta anterior", "Planificaci√≥n del D√≠a de la Mujer Trabajadora", "Coordinaci√≥n de actividades del D√≠a de Andaluc√≠a", "Seguimiento del alumnado con dificultades de aprendizaje", "Ruegos y preguntas"],
                "03": ["Lectura y aprobaci√≥n del acta anterior", "Elaborar calendario de sesiones de evaluaci√≥n", "Revisi√≥n del Plan de Convivencia y propuestas de mejora", "Planificaci√≥n del D√≠a del Libro con la biblioteca", "Ruegos y preguntas"],
                "04": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento del plan de lectoescritura", "Coordinaci√≥n de actividades del D√≠a del Libro", "An√°lisis de la segunda evaluaci√≥n y protocolo de repetidores", "Ruegos y preguntas"],
                "05": ["Lectura y aprobaci√≥n del acta anterior", "Propuesta de alumnado que no promociona", "Planificaci√≥n de calendario final de curso", "Gesti√≥n del proceso de libros de texto", "Ruegos y preguntas"],
                "06": ["Lectura y aprobaci√≥n del acta anterior", "An√°lisis de la evaluaci√≥n final", "Evaluaci√≥n final del Plan de Mejora", "Elaboraci√≥n de la memoria final", "Ruegos y preguntas"]
            },
            "CLAUSTRO": {
                "09": ["Lectura y aprobaci√≥n del acta anterior", "Informaci√≥n general inicio curso", "Constituci√≥n equipos de ciclo", "Aprobaci√≥n criterios programaciones", "Presentaci√≥n planes y programas educativos", "Propuesta actividades complementarias", "Proceso evaluaci√≥n inicial", "Ruegos y preguntas"],
                "10": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n inicial: conclusiones", "An√°lisis medidas atenci√≥n diversidad", "Propuesta Bienestar Emocional", "Formaci√≥n profesorado", "Ruegos y preguntas"],
                "11": ["Lectura y aprobaci√≥n del acta anterior", "Aprobaci√≥n Plan de Centro", "Seguimiento programaciones", "Informaci√≥n tutor√≠as y convivencia", "Revisi√≥n prevenci√≥n violencia y acoso", "Ruegos y preguntas"],
                "01": ["Lectura y aprobaci√≥n del acta anterior", "Valoraci√≥n 1¬™ evaluaci√≥n", "Ajustes metodol√≥gicos", "Seguimiento planes y programas institucionales", "Ruegos y preguntas"],
                "03": ["Lectura y aprobaci√≥n del acta anterior", "Valoraci√≥n 2¬™ evaluaci√≥n", "An√°lisis progreso alumnado", "Evaluaci√≥n intermedia PGA", "Ruegos y preguntas"],
                "05": ["Lectura y aprobaci√≥n del acta anterior", "Preparaci√≥n evaluaci√≥n final", "Criterios promoci√≥n LOMLOE", "Organizaci√≥n curso siguiente", "Ruegos y preguntas"],
                "06": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n final del curso", "Aprobaci√≥n memoria final", "Valoraci√≥n planes y programas", "Propuestas mejora pr√≥ximo curso", "Ruegos y preguntas"]
            },
            "CONSEJO ESCOLAR": {
                "09": ["Lectura y aprobaci√≥n del acta anterior", "Constituci√≥n Consejo Escolar", "Informaci√≥n inicio curso", "Aprobaci√≥n calendario escolar", "Constituci√≥n comisiones", "Ruegos y preguntas"],
                "10": ["Lectura y aprobaci√≥n del acta anterior", "Informaci√≥n desarrollo inicial", "Presentaci√≥n borrador PGA", "Aprobaci√≥n Plan Convivencia", "Ruegos y preguntas"],
                "11": ["Lectura y aprobaci√≥n del acta anterior", "Aprobaci√≥n PGA y presupuesto", "Informe organizaci√≥n docente", "Seguimiento Bienestar Emocional", "Ruegos y preguntas"],
                "01": ["Lectura y aprobaci√≥n del acta anterior", "Informaci√≥n econ√≥mica trimestre", "Evaluaci√≥n convivencia", "Informe actividad lectiva", "Ruegos y preguntas"],
                "03": ["Lectura y aprobaci√≥n del acta anterior", "Modificaciones presupuestarias", "Seguimiento PGA y resultados", "Informe comisiones", "Ruegos y preguntas"],
                "05": ["Lectura y aprobaci√≥n del acta anterior", "Informaci√≥n escolarizaci√≥n", "Previsi√≥n plantilla", "Planificaci√≥n fin curso", "Ruegos y preguntas"],
                "06": ["Lectura y aprobaci√≥n del acta anterior", "Aprobaci√≥n memoria final", "Valoraci√≥n general del curso", "Propuestas mejora pr√≥ximo curso", "Ruegos y preguntas"]
            },
            "EQUIPO DE ORIENTACI√ìN": {
                "09": ["Lectura y aprobaci√≥n del acta anterior", "Constituci√≥n del equipo de orientaci√≥n", "Valoraci√≥n inicial del alumnado NEAE. Revisi√≥n de informes previos, nuevas detecciones y planificaci√≥n de intervenciones", "Plan de acogida y adaptaci√≥n: estrategias para facilitar la integraci√≥n del alumnado, especialmente el de TEA", "Ruegos y preguntas"],
                "10": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento de la adaptaci√≥n del alumnado: evaluaci√≥n de dificultades iniciales y ajuste de medidas de apoyo", "Coordinaci√≥n con los tutores y especialistas: trabajo conjunto para garantizar coherencia en la intervenci√≥n educativa", "Estrategias para fomentar la inclusi√≥n: metodolog√≠a y recursos para mejorar la participaci√≥n del alumnado NEAE en el aula", "Propuestas de mejora", "Ruegos y preguntas"],
                "11": ["Lectura y aprobaci√≥n del acta anterior", "Revisi√≥n de la evoluci√≥n del alumnado: an√°lisis de avances y detecci√≥n de posibles ajustes en la intervenci√≥n", "Estrategias de apoyo emocional y convivencia: actuaciones para prevenir conflictos y promover el bienestar del alumnado", "Preparaci√≥n de las evaluaciones adaptadas: revisi√≥n de medidas para garantizar la accesibilidad en la primera evaluaci√≥n", "Ruegos y preguntas"],
                "12": ["Lectura y aprobaci√≥n del acta anterior", "Balance del trimestre y ajustes en la intervenci√≥n: reflexi√≥n sobre las medidas aplicadas y propuestas de mejora", "Coordinaci√≥n con familias: preparaci√≥n de las reuniones para informar sobre los avances y necesidades", "Actividades inclusivas de Navidad: organizaci√≥n de eventos en los que todo el alumnado pueda participar", "Ruegos y preguntas"],
                "01": ["Lectura y aprobaci√≥n del acta anterior", "An√°lisis del primer trimestre: revisi√≥n de logros y dificultades detectadas en las evaluaciones", "Refuerzo educativo y adaptaci√≥n de estrategias: planificaci√≥n de nuevas medidas de apoyo en el aula TEA y alumnado NEAE", "Atenci√≥n a la diversidad en el aula: estrategias para potenciar la autonom√≠a y el aprendizaje significativo", "Ruegos y preguntas"],
                "02": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento de casos y ajuste de medidas ‚Äì Evaluaci√≥n de la evoluci√≥n del alumnado con NEAE y propuestas de intervenci√≥n", "Estrategias para la inclusi√≥n en actividades escolares ‚Äì Adaptaci√≥n de proyectos, salidas y celebraciones", "Apoyo emocional y conducta ‚Äì Intervenci√≥n en casos de ansiedad, dificultades sociales o problemas de conducta", "Ruegos y preguntas"],
                "03": ["Lectura y aprobaci√≥n del acta anterior", "Revisi√≥n de la evoluci√≥n del alumnado ‚Äì An√°lisis de avances antes de la segunda evaluaci√≥n", "Pruebas de diagn√≥stico (alumnado con NEE)", "Planificaci√≥n de medidas para la recta final del curso ‚Äì Ajuste de apoyos y preparaci√≥n para la transici√≥n de etapa", "Ruegos y preguntas"],
                "04": ["Lectura y aprobaci√≥n del acta anterior", "Seguimiento del alumnado en riesgo de repetici√≥n o con dificultades ‚Äì Evaluaci√≥n de medidas y alternativas de refuerzo", "Transici√≥n entre etapas ‚Äì Plan de actuaci√≥n para alumnado que pasar√° a secundaria o a un nuevo ciclo", "Actividades de concienciaci√≥n y sensibilizaci√≥n ‚Äì Proyectos inclusivos para fomentar la convivencia", "Ruegos y preguntas"],
                "05": ["Lectura y aprobaci√≥n del acta anterior", "Evaluaci√≥n de la respuesta del alumnado a las medidas implantadas ‚Äì Valoraci√≥n del impacto de las estrategias aplicadas", "Preparaci√≥n del cierre de curso ‚Äì Revisi√≥n de informes y orientaciones para el pr√≥ximo a√±o", "Inclusi√≥n en actividades de fin de curso ‚Äì Adaptaci√≥n de celebraciones para garantizar la participaci√≥n de todos", "Ruegos y preguntas"],
                "06": ["Lectura y aprobaci√≥n del acta anterior", "Balance del curso y propuestas de mejora ‚Äì Reflexi√≥n sobre los puntos fuertes y d√©biles del trabajo del equipo", "Elaboraci√≥n de informes finales ‚Äì Registro de orientaciones para el pr√≥ximo curso y recomendaciones a tutores y familias", "Planificaci√≥n del inicio del pr√≥ximo curso ‚Äì Estrategias para la acogida de nuevo alumnado y puesta en marcha de protocolos", "Ruegos y preguntas"]
            }
        };

        // Mapeo de tipos de reuni√≥n a √≥rganos
        const mapeoReunionOrgano = {
            "infantil-3": "EQUIPOS DOCENTES", "infantil-4": "EQUIPOS DOCENTES", "infantil-5": "EQUIPOS DOCENTES",
            "primero": "EQUIPOS DOCENTES", "segundo": "EQUIPOS DOCENTES", "tercero": "EQUIPOS DOCENTES",
            "cuarto": "EQUIPOS DOCENTES", "quinto": "EQUIPOS DOCENTES", "sexto": "EQUIPOS DOCENTES",
            "ciclo-infantil": "EQUIPOS DE CICLO", "primer-ciclo": "EQUIPOS DE CICLO",
            "segundo-ciclo": "EQUIPOS DE CICLO", "tercer-ciclo": "EQUIPOS DE CICLO",
            "orientacion": "EQUIPO DE ORIENTACI√ìN", "aula-tea": "EQUIPO DE ORIENTACI√ìN",
            "claustro": "CLAUSTRO", "etcp": "ETCP", "consejo-escolar": "CONSEJO ESCOLAR"
        };

        // Mostrar indicador de conexi√≥n
        document.getElementById('statusIndicator').style.display = 'flex';

        // Diccionario de nombres amigables
        const nombresReunion = {
            'infantil-3': 'Infantil 3 a√±os',
            'infantil-4': 'Infantil 4 a√±os',
            'infantil-5': 'Infantil 5 a√±os',
            'primero': '1¬∫ de Primaria',
            'segundo': '2¬∫ de Primaria',
            'tercero': '3¬∫ de Primaria',
            'cuarto': '4¬∫ de Primaria',
            'quinto': '5¬∫ de Primaria',
            'sexto': '6¬∫ de Primaria',
            'ciclo-infantil': 'Ciclo Infantil',
            'primer-ciclo': 'Primer Ciclo Primaria',
            'segundo-ciclo': 'Segundo Ciclo Primaria',
            'tercer-ciclo': 'Tercer Ciclo Primaria',
            'orientacion': 'Equipo de Orientaci√≥n',
            'aula-tea': 'Aula TEA',
            'claustro': 'Claustro',
            'etcp': 'ETCP (Equipo T√©cnico de Coordinaci√≥n Pedag√≥gica)',
            'consejo-escolar': 'Consejo Escolar'
        };

        // Formatear fecha
        window.formatearFecha = function(fecha) {
            const partes = fecha.split('-');
            return `${partes[2]}/${partes[1]}/${partes[0]}`;
        };

        // Obtener nombre amigable
        window.getNombreReunion = function(id, fecha) {
            return nombresReunion[id] + ' - ' + formatearFecha(fecha);
        };

        // Cambiar pantalla
        window.cambiarPantalla = function(pantalla) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(pantalla).classList.add('active');
        };

        // Establecer fecha de hoy por defecto
        document.getElementById('inputFecha').valueAsDate = new Date();

        // Crear sesi√≥n
        window.crearSesion = async function() {
            const nombre = document.getElementById('inputNombre').value.trim();
            const rol = document.getElementById('selectRol').value;
            const idReunion = document.getElementById('selectReunion').value;
            const fecha = document.getElementById('inputFecha').value;

            if (!nombre) {
                alert('Por favor, introduce tu nombre');
                return;
            }

            if (!idReunion) {
                alert('Por favor, selecciona un curso/ciclo/equipo/√≥rgano');
                return;
            }

            if (!fecha) {
                alert('Por favor, selecciona una fecha para la reuni√≥n');
                return;
            }

            if (rol !== 'coordinador') {
                alert('Solo el coordinador puede crear reuniones. Usa "Unirse a Reuni√≥n"');
                return;
            }

            window.sesionActual = idReunion;
            window.fechaActual = fecha;
            window.usuarioActual = { nombre, rol };

            // Verificar si ya existe la reuni√≥n
            const sesionRef = ref(database, `sesiones/${idReunion}/${fecha}`);
            const snapshot = await get(sesionRef);

            if (snapshot.exists()) {
                // La reuni√≥n ya existe
                const sesionData = snapshot.val();
                const confirmacion = confirm(
                    `Ya existe una reuni√≥n de ${getNombreReunion(idReunion, fecha)} creada el ${new Date(sesionData.creada).toLocaleString('es-ES')}.\n\n` +
                    `¬øQu√© quieres hacer?\n\n` +
                    `OK = Continuar editando esta reuni√≥n\n` +
                    `Cancelar = Volver atr√°s`
                );
                
                if (!confirmacion) {
                    return;
                }
                
                // Configurar y mostrar pantalla de configuraci√≥n
                document.getElementById('nombreReunion').textContent = getNombreReunion(idReunion, fecha);
                setupPuntosListener();
                cambiarPantalla('screenConfig');
            } else {
                // Crear nueva reuni√≥n
                await set(sesionRef, {
                    creada: Date.now(),
                    estado: 'configurando',
                    fecha: fecha,
                    nombre: getNombreReunion(idReunion, fecha)
                });
                
                // Cargar puntos predefinidos autom√°ticamente
                await cargarPuntosPredefinidos(idReunion, fecha);
                
                document.getElementById('nombreReunion').textContent = getNombreReunion(idReunion, fecha);
                setupPuntosListener();
                cambiarPantalla('screenConfig');
            }
        };

        // Funci√≥n para cargar puntos predefinidos
        window.cargarPuntosPredefinidos = async function(tipoReunion, fecha) {
            // Obtener mes de la fecha (formato MM)
            const mes = fecha.split('-')[1]; // fecha est√° en formato YYYY-MM-DD
            
            // Mapear tipo de reuni√≥n a √≥rgano
            const organo = mapeoReunionOrgano[tipoReunion];
            
            if (!organo) {
                console.log('No hay mapeo para este tipo de reuni√≥n');
                return;
            }
            
            // Obtener puntos predefinidos para este √≥rgano y mes
            const puntosPredefinidos = ordenDelDiaPredefinido[organo]?.[mes];
            
            if (!puntosPredefinidos || puntosPredefinidos.length === 0) {
                console.log(`No hay puntos predefinidos para ${organo} en el mes ${mes}`);
                return;
            }
            
            // A√±adir cada punto predefinido a Firebase
            const puntosRef = ref(database, `sesiones/${tipoReunion}/${fecha}/puntos`);
            
            for (let i = 0; i < puntosPredefinidos.length; i++) {
                const nuevoPuntoRef = push(puntosRef);
                await set(nuevoPuntoRef, {
                    texto: puntosPredefinidos[i],
                    orden: Date.now() + i // Asegurar orden correcto
                });
            }
            
            console.log(`‚úÖ Cargados ${puntosPredefinidos.length} puntos predefinidos para ${organo}`);
        };

        // Unirse a sesi√≥n
        window.unirseASesion = async function() {
            const nombre = document.getElementById('inputNombre').value.trim();
            const rol = document.getElementById('selectRol').value;
            const idReunion = document.getElementById('selectReunion').value;
            const fecha = document.getElementById('inputFecha').value;

            if (!nombre) {
                alert('Por favor, introduce tu nombre');
                return;
            }

            if (!idReunion) {
                alert('Por favor, selecciona un curso/ciclo/equipo/√≥rgano');
                return;
            }

            if (!fecha) {
                alert('Por favor, selecciona una fecha para la reuni√≥n');
                return;
            }

            window.sesionActual = idReunion;
            window.fechaActual = fecha;
            
            // Normalizar nombre: sin espacios extra, min√∫sculas para la key
            const nombreNormalizado = nombre.trim().toLowerCase().replace(/\s+/g, '-');
            
            window.usuarioActual = { 
                nombre: nombre.trim(),  // Nombre original para mostrar
                nombreKey: nombreNormalizado,  // Nombre normalizado para key
                rol 
            };

            // Verificar si existe la reuni√≥n
            const sesionRef = ref(database, `sesiones/${idReunion}/${fecha}`);
            const snapshot = await get(sesionRef);

            if (!snapshot.exists()) {
                alert('La reuni√≥n no existe. El coordinador debe crearla primero.');
                return;
            }

            const sesionData = snapshot.val();

            // Registrar como participante usando nombre normalizado como key
            const participanteRef = ref(database, `sesiones/${idReunion}/${fecha}/participantes/${nombreNormalizado}`);
            await set(participanteRef, {
                nombre: nombre.trim(),
                rol: rol,
                timestamp: Date.now()
            });

            // Si la reuni√≥n a√∫n est√° en configuraci√≥n y eres coordinador, ir a configuraci√≥n
            if (sesionData.estado === 'configurando' && rol === 'coordinador') {
                const nombreReunion = getNombreReunion(idReunion, fecha);
                document.getElementById('nombreReunion').textContent = nombreReunion;
                mostrarTituloReunion(nombreReunion);
                setupPuntosListener();
                cambiarPantalla('screenConfig');
                return;
            }

            // En cualquier otro caso, llevar a la pantalla de reuni√≥n
            const nombreReunion = getNombreReunion(idReunion, fecha);
            document.getElementById('nombreActual').textContent = nombreReunion;
            mostrarTituloReunion(nombreReunion);
            cargarReunion();
            cambiarPantalla('screenReunion');
        };

        // Agregar punto del orden del d√≠a
        window.agregarPunto = function() {
            const texto = document.getElementById('inputNuevoPunto').value.trim();
            if (!texto) {
                alert('Escribe el punto del orden del d√≠a');
                return;
            }

            const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
            const nuevoPuntoRef = push(puntosRef);
            
            set(nuevoPuntoRef, {
                texto: texto,
                orden: Date.now()
            });

            document.getElementById('inputNuevoPunto').value = '';
        };

        // Eliminar punto
        window.eliminarPunto = function(puntoId) {
            if (!confirm('¬øSeguro que quieres eliminar este punto del orden del d√≠a?')) {
                return;
            }
            const puntoRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}`);
            remove(puntoRef);
        };

        // Iniciar reuni√≥n
        window.iniciarReunion = async function() {
            const sesionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}`);
            update(sesionRef, { estado: 'activa' });

            // Registrar coordinador como participante
            const participanteRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/participantes/${window.usuarioActual.nombre}`);
            set(participanteRef, {
                nombre: window.usuarioActual.nombre,
                rol: window.usuarioActual.rol,
                timestamp: Date.now()
            });

            const nombreReunion = getNombreReunion(window.sesionActual, window.fechaActual);
            document.getElementById('nombreActual').textContent = nombreReunion;
            mostrarTituloReunion(nombreReunion);
            cargarReunion();
            cambiarPantalla('screenReunion');
        };

        // Cargar reuni√≥n
        window.cargarReunion = function() {
            cargarParticipantes();
            cargarVideollamada();
            inicializarChatGeneral();

            // Ajustar margen del contenedor
            document.getElementById('containerReunion').classList.add('con-chat');

            // Escuchar cambios en participantes
            const participantesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/participantes`);
            onValue(participantesRef, () => {
                cargarParticipantes();
            });

            // Escuchar cambios en videollamada
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            onValue(videollamadaRef, () => {
                cargarVideollamada();
            });

            // Listener √öNICO para puntos - solo se activa una vez
            if (!puntosListenerActivo) {
                puntosListenerActivo = true;
                const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
                onValue(puntosRef, (snapshot) => {
                    cargarPuntosDesdeCero(snapshot);
                });
            }
        };

        // Inicializar chat general
        window.inicializarChatGeneral = function() {
            const chatGeneralRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/chatGeneral`);
            
            onValue(chatGeneralRef, (snapshot) => {
                cargarMensajesGenerales();
            });
        };

        // Enviar mensaje al chat general
        window.enviarMensajeGeneral = async function() {
            const input = document.getElementById('inputChatGeneral');
            const texto = input.value.trim();

            if (!texto) return;

            const chatGeneralRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/chatGeneral`);
            const nuevoMensajeRef = push(chatGeneralRef);

            await set(nuevoMensajeRef, {
                autor: window.usuarioActual.nombre,
                rol: window.usuarioActual.rol,
                texto: texto,
                timestamp: Date.now()
            });

            input.value = '';
        };

        // Cargar mensajes generales
        window.cargarMensajesGenerales = async function() {
            const contenedor = document.getElementById('mensajesGenerales');
            if (!contenedor) return;

            const chatGeneralRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/chatGeneral`);
            
            try {
                const snapshot = await get(chatGeneralRef);

                if (!snapshot.exists()) {
                    contenedor.innerHTML = '<div class="empty-state"><div class="emoji">üí¨</div><p style="font-size: 13px;">No hay mensajes a√∫n</p></div>';
                    return;
                }

                const mensajes = snapshot.val();
                const mensajesArray = Object.entries(mensajes).map(([id, data]) => ({ id, ...data }));
                mensajesArray.sort((a, b) => a.timestamp - b.timestamp);

                contenedor.innerHTML = '';
                
                mensajesArray.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'mensaje-general';
                    
                    const esAutor = msg.autor === window.usuarioActual.nombre;
                    const esCoordinador = window.usuarioActual.rol === 'coordinador';
                    const puedeEditar = esAutor || esCoordinador;
                    
                    div.innerHTML = `
                        <div class="mensaje-general-header">
                            <span class="mensaje-general-autor">
                                ${msg.rol === 'coordinador' ? 'üëë' : msg.rol === 'familia' ? 'üë®‚Äçüë©‚Äçüëß' : 'üë§'} ${msg.autor}
                            </span>
                            <span class="mensaje-general-hora">${new Date(msg.timestamp).toLocaleTimeString('es-ES', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}</span>
                        </div>
                        <div class="mensaje-general-texto">${msg.texto}</div>
                        ${puedeEditar ? `
                            <div style="margin-top: 6px; display: flex; gap: 6px;">
                                <button onclick="editarMensajeChat('${msg.id}')" 
                                        style="padding: 3px 8px; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="borrarMensajeChat('${msg.id}')" 
                                        style="padding: 3px 8px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    üóëÔ∏è Borrar
                                </button>
                            </div>
                        ` : ''}
                    `;
                    contenedor.appendChild(div);
                });

                // Scroll autom√°tico al final
                contenedor.scrollTop = contenedor.scrollHeight;
                
            } catch (error) {
                console.error('Error cargando chat general:', error);
            }
        };

        // Editar mensaje del chat general (autor o coordinador)
        window.editarMensajeChat = async function(mensajeId) {
            const mensajeRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/chatGeneral/${mensajeId}`);
            const snapshot = await get(mensajeRef);
            
            if (!snapshot.exists()) {
                alert('Mensaje no encontrado');
                return;
            }
            
            const mensaje = snapshot.val();
            
            // Verificar permisos
            const esAutor = mensaje.autor === window.usuarioActual.nombre;
            const esCoordinador = window.usuarioActual.rol === 'coordinador';
            
            if (!esAutor && !esCoordinador) {
                alert('Solo puedes editar tus propios mensajes');
                return;
            }
            
            // Crear modal para editar
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">‚úèÔ∏è Editar mensaje</h3>
                    <textarea id="textareaEditarMensajeChat" style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;">${mensaje.texto}</textarea>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="this.closest('div').parentElement.parentElement.remove()" style="flex: 1; padding: 12px; background: transparent; border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cancelar
                        </button>
                        <button id="btnGuardarEdicionChat" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Guardar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus en el textarea
            const textarea = document.getElementById('textareaEditarMensajeChat');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            
            // Evento para guardar
            document.getElementById('btnGuardarEdicionChat').onclick = async function() {
                const nuevoTexto = textarea.value.trim();
                
                if (nuevoTexto !== '') {
                    await update(mensajeRef, { texto: nuevoTexto });
                    modal.remove();
                } else {
                    alert('El texto no puede estar vac√≠o');
                }
            };
            
            // Cerrar modal al hacer clic fuera
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        };

        // Borrar mensaje del chat general (autor o coordinador)
        window.borrarMensajeChat = async function(mensajeId) {
            const mensajeRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/chatGeneral/${mensajeId}`);
            const snapshot = await get(mensajeRef);
            
            if (!snapshot.exists()) {
                alert('Mensaje no encontrado');
                return;
            }
            
            const mensaje = snapshot.val();
            
            // Verificar permisos
            const esAutor = mensaje.autor === window.usuarioActual.nombre;
            const esCoordinador = window.usuarioActual.rol === 'coordinador';
            
            if (!esAutor && !esCoordinador) {
                alert('Solo puedes borrar tus propios mensajes');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres borrar este mensaje?')) {
                await remove(mensajeRef);
            }
        };

        // Toggle chat lateral (minimizar/maximizar)
        window.toggleChatLateral = function() {
            const chat = document.getElementById('chatLateral');
            const toggle = document.getElementById('chatToggle');
            
            if (chat.classList.contains('minimizado')) {
                chat.classList.remove('minimizado');
                toggle.textContent = '‚àí';
            } else {
                chat.classList.add('minimizado');
                toggle.textContent = '+';
            }
        };

        // Recargar puntos completamente desde cero
        window.cargarPuntosDesdeCero = function(snapshot) {
            const contenedor = document.getElementById('contenidoPuntos');
            
            // Limpiar listeners antiguos (los listeners de Firebase se limpian cuando se borra el DOM)
            listenersPorPunto.clear();
            
            // Limpiar TODO el contenedor
            contenedor.innerHTML = '';

            if (!snapshot.exists()) {
                contenedor.innerHTML = '<div class="empty-state"><div class="emoji">üìã</div><p>No hay puntos del orden del d√≠a</p></div>';
                return;
            }

            const puntos = snapshot.val();
            const puntosArray = Object.entries(puntos).map(([id, data]) => ({ id, ...data }));
            puntosArray.sort((a, b) => a.orden - b.orden);

            puntosArray.forEach((punto, index) => {
                const card = crearPuntoCard(punto, index + 1);
                contenedor.appendChild(card);
            });
        };

        // Cargar participantes
        window.cargarParticipantes = async function() {
            const lista = document.getElementById('listaParticipantes');
            lista.innerHTML = '';

            const participantesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/participantes`);
            const snapshot = await get(participantesRef);

            if (!snapshot.exists()) {
                document.getElementById('numParticipantes').textContent = '(0)';
                return;
            }

            const participantes = snapshot.val();
            const participantesArray = Object.entries(participantes).map(([id, data]) => ({id, ...data}));

            participantesArray.forEach(p => {
                const container = document.createElement('div');
                container.style.cssText = 'display: inline-flex; align-items: center; gap: 8px; margin: 5px 5px 5px 0;';
                
                const badge = document.createElement('span');
                badge.className = `user-badge ${p.rol}`;
                
                // Determinar el icono seg√∫n el rol
                let icono = 'üë§'; // Maestro por defecto
                if (p.rol === 'coordinador') icono = 'üëë';
                else if (p.rol === 'familia') icono = 'üë®‚Äçüë©‚Äçüëß';
                
                badge.innerHTML = `${icono} ${p.nombre}`;
                container.appendChild(badge);
                
                // Bot√≥n de eliminar solo para coordinador y solo si el participante no es coordinador
                if (window.usuarioActual.rol === 'coordinador' && p.rol !== 'coordinador') {
                    const btnEliminar = document.createElement('button');
                    btnEliminar.innerHTML = 'üóëÔ∏è';
                    btnEliminar.style.cssText = 'background: var(--danger); color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;';
                    btnEliminar.title = 'Eliminar participante';
                    btnEliminar.onclick = () => eliminarParticipante(p.id);
                    container.appendChild(btnEliminar);
                }
                
                lista.appendChild(container);
            });

            document.getElementById('numParticipantes').textContent = `(${participantesArray.length})`;
        };

        // Eliminar participante (solo coordinador)
        window.eliminarParticipante = async function(participanteId) {
            if (window.usuarioActual.rol !== 'coordinador') {
                alert('Solo el coordinador puede eliminar participantes');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este participante?')) {
                return;
            }
            
            const participanteRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/participantes/${participanteId}`);
            await remove(participanteRef);
            
            // Recargar lista de participantes
            cargarParticipantes();
        };

        // Cargar puntos del orden del d√≠a - Solo carga inicial
        window.cargarPuntos = async function() {
            const contenedor = document.getElementById('contenidoPuntos');
            contenedor.innerHTML = '';

            const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
            const snapshot = await get(puntosRef);

            if (!snapshot.exists()) {
                contenedor.innerHTML = '<div class="empty-state"><div class="emoji">üìã</div><p>No hay puntos del orden del d√≠a</p></div>';
                return;
            }

            const puntos = snapshot.val();
            const puntosArray = Object.entries(puntos).map(([id, data]) => ({ id, ...data }));
            puntosArray.sort((a, b) => a.orden - b.orden);

            puntosArray.forEach((punto, index) => {
                const card = crearPuntoCard(punto, index + 1);
                contenedor.appendChild(card);
            });
        };

        // Crear card de punto
        window.crearPuntoCard = function(punto, numero) {
            const card = document.createElement('div');
            card.className = 'card';
            card.setAttribute('data-punto-id', punto.id);
            card.innerHTML = `
                <div class="punto-header">
                    <div class="punto-numero">${numero}</div>
                    <div class="punto-titulo">${punto.texto}</div>
                </div>

                ${window.usuarioActual.rol === 'coordinador' ? `
                <div style="margin: 20px 0; padding: 15px; background: var(--background); border-radius: 8px;">
                    <strong style="display: block; margin-bottom: 10px;">üìé Adjuntar documento:</strong>
                    <div style="display: grid; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="nombre_doc_${punto.id}" placeholder="Nombre del documento (ej: Objetivos Trimestre 1)" style="margin: 0;">
                        <input type="url" id="link_doc_${punto.id}" placeholder="Enlace de Google Drive (o cualquier URL)" style="margin: 0;">
                    </div>
                    <button class="btn btn-outline btn-small" onclick="adjuntarDocumento('${punto.id}')" style="width: 100%;">
                        üìé Adjuntar
                    </button>
                </div>
                ` : ''}

                <div id="documentos_${punto.id}" style="margin: 20px 0;"></div>

                <div style="margin: 20px 0;">
                    <strong style="display: block; margin-bottom: 10px;">üí¨ Conversaci√≥n:</strong>
                    <div id="aportaciones_${punto.id}" class="chat-container"></div>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <textarea id="input_${punto.id}" placeholder="Escribe tu comentario... (Enter para enviar, Shift+Enter para nueva l√≠nea)" style="flex: 1; margin: 0; min-height: 60px;" rows="2" onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); agregarAportacion('${punto.id}'); }"></textarea>
                        <button class="btn btn-secondary" onclick="agregarAportacion('${punto.id}')" style="width: auto; padding: 12px 20px; margin: 0; height: fit-content;">
                            üìù Enviar
                        </button>
                    </div>
                </div>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border);">
                    <strong style="display: block; margin-bottom: 10px;">üó≥Ô∏è Votaci√≥n:</strong>
                    ${window.usuarioActual.rol === 'coordinador' ? `
                        <div class="btn-group">
                            <button class="btn btn-outline btn-small" onclick="crearVotacion('${punto.id}', false)">
                                Votaci√≥n An√≥nima
                            </button>
                            <button class="btn btn-outline btn-small" onclick="crearVotacion('${punto.id}', true)">
                                Votaci√≥n con Nombres
                            </button>
                        </div>
                    ` : ''}
                    <div id="votacion_${punto.id}"></div>
                </div>
            `;

            // Cargar contenido inicial
            setTimeout(() => {
                cargarAportaciones(punto.id);
                cargarVotacion(punto.id);
                cargarDocumentos(punto.id);
            }, 50);

            // Registrar que este punto tiene listeners activos
            if (!listenersPorPunto.has(punto.id)) {
                listenersPorPunto.set(punto.id, true);
                
                // Listeners en tiempo real
                const aportacionesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${punto.id}/aportaciones`);
                onValue(aportacionesRef, () => {
                    cargarAportaciones(punto.id);
                });

                const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${punto.id}/votacion`);
                onValue(votacionRef, () => {
                    cargarVotacion(punto.id);
                });

                const documentosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${punto.id}/documentos`);
                onValue(documentosRef, () => {
                    cargarDocumentos(punto.id);
                });
            }

            return card;
        };

        // Agregar aportaci√≥n
        window.agregarAportacion = async function(puntoId) {
            const input = document.getElementById('input_' + puntoId);
            const texto = input.value.trim();

            if (!texto) {
                alert('Escribe un comentario');
                return;
            }

            const aportacionesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/aportaciones`);
            const nuevaAportacionRef = push(aportacionesRef);

            await set(nuevaAportacionRef, {
                autor: window.usuarioActual.nombre,
                rol: window.usuarioActual.rol,
                texto: texto,
                timestamp: Date.now()
            });

            input.value = '';
        };

        // Cargar aportaciones (estilo WhatsApp)
        window.cargarAportaciones = async function(puntoId) {
            const contenedor = document.getElementById('aportaciones_' + puntoId);
            if (!contenedor) return;

            const aportacionesRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/aportaciones`);
            
            try {
                const snapshot = await get(aportacionesRef);

                if (!snapshot.exists()) {
                    contenedor.innerHTML = '<div class="empty-state"><div class="emoji">üí≠</div><p>No hay comentarios a√∫n. ¬°S√© el primero!</p></div>';
                    return;
                }

                const aportaciones = snapshot.val();
                const aportacionesArray = Object.values(aportaciones);
                aportacionesArray.sort((a, b) => a.timestamp - b.timestamp);

                contenedor.innerHTML = '';
                
                aportacionesArray.forEach((aport, index) => {
                    const div = document.createElement('div');
                    div.className = 'aportacion';
                    div.setAttribute('data-aport-id', Object.keys(aportaciones)[index]);
                    
                    const esAutor = aport.autor === window.usuarioActual.nombre;
                    const esCoordinador = window.usuarioActual.rol === 'coordinador';
                    const puedeEditar = esAutor || esCoordinador;
                    
                    div.innerHTML = `
                        <div class="aportacion-header">
                            <span class="aportacion-autor">
                                ${aport.rol === 'coordinador' ? 'üëë' : 'üë§'} <strong>${aport.autor}</strong>
                            </span>
                            <span class="aportacion-hora">${new Date(aport.timestamp).toLocaleString('es-ES', { 
                                day: '2-digit', 
                                month: '2-digit', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}</span>
                        </div>
                        <div class="aportacion-texto">${aport.texto}</div>
                        ${puedeEditar ? `
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button onclick="editarAportacion('${puntoId}', '${Object.keys(aportaciones)[index]}')" 
                                        style="padding: 4px 10px; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="borrarAportacion('${puntoId}', '${Object.keys(aportaciones)[index]}')" 
                                        style="padding: 4px 10px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    üóëÔ∏è Borrar
                                </button>
                            </div>
                        ` : ''}
                    `;
                    contenedor.appendChild(div);
                });

                // Scroll autom√°tico al final (como WhatsApp)
                contenedor.scrollTop = contenedor.scrollHeight;
                
            } catch (error) {
                console.error('Error cargando aportaciones:', error);
                contenedor.innerHTML = '<div class="empty-state"><div class="emoji">‚ö†Ô∏è</div><p>Error cargando comentarios</p></div>';
            }
        };

        // Editar aportaci√≥n (autor o coordinador)
        window.editarAportacion = async function(puntoId, aportacionId) {
            const aportacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/aportaciones/${aportacionId}`);
            const snapshot = await get(aportacionRef);
            
            if (!snapshot.exists()) {
                alert('Aportaci√≥n no encontrada');
                return;
            }
            
            const aportacion = snapshot.val();
            
            // Verificar que el usuario actual es el autor O es coordinador
            const esAutor = aportacion.autor === window.usuarioActual.nombre;
            const esCoordinador = window.usuarioActual.rol === 'coordinador';
            
            if (!esAutor && !esCoordinador) {
                alert('Solo puedes editar tus propias aportaciones');
                return;
            }
            
            // Crear modal para editar con textarea grande
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 25px; max-width: 600px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="margin-bottom: 15px; color: var(--primary);">‚úèÔ∏è Editar aportaci√≥n</h3>
                    <textarea id="textareaEditarAportacion" style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px; font-family: inherit; resize: vertical;">${aportacion.texto}</textarea>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="this.closest('div').parentElement.parentElement.remove()" style="flex: 1; padding: 12px; background: transparent; border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Cancelar
                        </button>
                        <button id="btnGuardarEdicion" style="flex: 1; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Guardar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Focus en el textarea
            const textarea = document.getElementById('textareaEditarAportacion');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            
            // Evento para guardar
            document.getElementById('btnGuardarEdicion').onclick = async function() {
                const nuevoTexto = textarea.value.trim();
                
                if (nuevoTexto !== '') {
                    await update(aportacionRef, {
                        texto: nuevoTexto
                    });
                    modal.remove();
                } else {
                    alert('El texto no puede estar vac√≠o');
                }
            };
            
            // Cerrar modal al hacer clic fuera
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        };

        // Borrar aportaci√≥n (autor o coordinador)
        window.borrarAportacion = async function(puntoId, aportacionId) {
            const aportacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/aportaciones/${aportacionId}`);
            const snapshot = await get(aportacionRef);
            
            if (!snapshot.exists()) {
                alert('Aportaci√≥n no encontrada');
                return;
            }
            
            const aportacion = snapshot.val();
            
            // Verificar que el usuario actual es el autor O es coordinador
            const esAutor = aportacion.autor === window.usuarioActual.nombre;
            const esCoordinador = window.usuarioActual.rol === 'coordinador';
            
            if (!esAutor && !esCoordinador) {
                alert('Solo puedes borrar tus propias aportaciones');
                return;
            }
            
            if (confirm('¬øEst√°s seguro de que quieres borrar esta aportaci√≥n?')) {
                await remove(aportacionRef);
            }
        };

        // Adjuntar documento
        window.adjuntarDocumento = async function(puntoId) {
            const nombreInput = document.getElementById('nombre_doc_' + puntoId);
            const linkInput = document.getElementById('link_doc_' + puntoId);
            
            const nombre = nombreInput.value.trim();
            const link = linkInput.value.trim();

            if (!nombre || !link) {
                alert('Por favor completa el nombre y el enlace del documento');
                return;
            }

            // Validar que es una URL
            try {
                new URL(link);
            } catch {
                alert('El enlace no es v√°lido. Aseg√∫rate de incluir https://');
                return;
            }

            const documentosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/documentos`);
            const nuevoDocumentoRef = push(documentosRef);

            await set(nuevoDocumentoRef, {
                nombre: nombre,
                link: link,
                autor: window.usuarioActual.nombre,
                timestamp: Date.now()
            });

            // Limpiar campos
            nombreInput.value = '';
            linkInput.value = '';
        };

        // Eliminar documento (solo coordinador)
        window.eliminarDocumento = async function(puntoId, documentoId) {
            if (window.usuarioActual.rol !== 'coordinador') {
                alert('Solo el coordinador puede eliminar documentos');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este documento?')) {
                return;
            }
            
            const documentoRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/documentos/${documentoId}`);
            await remove(documentoRef);
        };

        // Cargar documentos
        window.cargarDocumentos = async function(puntoId) {
            const contenedor = document.getElementById('documentos_' + puntoId);
            if (!contenedor) return;

            const documentosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/documentos`);
            
            try {
                const snapshot = await get(documentosRef);

                if (!snapshot.exists()) {
                    contenedor.innerHTML = '';
                    return;
                }

                const documentos = snapshot.val();
                const documentosArray = Object.entries(documentos).map(([id, data]) => ({id, ...data}));
                documentosArray.sort((a, b) => a.timestamp - b.timestamp);

                contenedor.innerHTML = '<strong style="display: block; margin-bottom: 10px;">üìé Documentos adjuntos:</strong>';
                
                documentosArray.forEach(doc => {
                    const div = document.createElement('div');
                    div.style.cssText = 'background: var(--background); padding: 12px; border-radius: 8px; margin-bottom: 8px;';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                            <div style="flex: 1;">
                                <strong style="display: block; color: var(--primary); margin-bottom: 4px;">${doc.nombre}</strong>
                                <a href="${doc.link}" target="_blank" style="color: var(--secondary); font-size: 13px; word-break: break-all;">üîó Abrir enlace</a>
                                <div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">
                                    Subido por ${doc.autor} ‚Ä¢ ${new Date(doc.timestamp).toLocaleString('es-ES', { 
                                        day: '2-digit', 
                                        month: '2-digit', 
                                        hour: '2-digit', 
                                        minute: '2-digit' 
                                    })}
                                </div>
                            </div>
                            <div style="display: flex; gap: 5px; flex-shrink: 0;">
                                <button onclick="shareLinksManager.shareLink('${doc.link}', '${doc.nombre.replace(/'/g, "\\'")}', '', '')" 
                                        style="background: #4CAF50; color: white; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 8px;" 
                                        title="Compartir documento">
                                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                        <path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                    </svg>
                                </button>
                                ${window.usuarioActual.rol === 'coordinador' ? `
                                    <button onclick="eliminarDocumento('${puntoId}', '${doc.id}')" 
                                            style="background: var(--danger); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;" 
                                            title="Eliminar documento">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    contenedor.appendChild(div);
                });
                
            } catch (error) {
                console.error('Error cargando documentos:', error);
            }
        };

        // Crear votaci√≥n
        window.crearVotacion = async function(puntoId, conNombres) {
            const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion`);
            
            await set(votacionRef, {
                activa: true,
                conNombres: conNombres,
                timestamp: Date.now()
            });
        };

        // Cargar votaci√≥n
        window.cargarVotacion = async function(puntoId) {
            const contenedor = document.getElementById('votacion_' + puntoId);
            if (!contenedor) return;

            const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion`);
            
            try {
                const snapshot = await get(votacionRef);

                if (!snapshot.exists() || !snapshot.val().activa) {
                    contenedor.innerHTML = '';
                    return;
                }

                const votacion = snapshot.val();
                const votos = votacion.votos || {};
                const miVoto = votos[window.usuarioActual.nombre];

                // Contar votos
                const conteo = { si: 0, no: 0, abstencion: 0 };
                Object.values(votos).forEach(v => {
                    conteo[v.voto]++;
                });
                const total = Object.keys(votos).length;

                contenedor.innerHTML = `
                    <div class="votacion-card">
                        <h3 style="margin-bottom: 10px;">${votacion.conNombres ? 'üó≥Ô∏è Votaci√≥n P√∫blica' : 'üîí Votaci√≥n An√≥nima'}</h3>
                        ${miVoto ? 
                            `<p style="margin-bottom: 15px;">Has votado: <strong>${miVoto.voto === 'si' ? '‚úÖ S√≠' : miVoto.voto === 'no' ? '‚ùå No' : '‚ö™ Abstenci√≥n'}</strong></p>` 
                            : '<p style="margin-bottom: 15px;">Emite tu voto:</p>'}
                        <div class="votacion-opciones">
                            <button class="voto-btn ${miVoto && miVoto.voto === 'si' ? 'selected' : ''}" 
                                onclick="votar('${puntoId}', 'si')" ${miVoto ? 'disabled' : ''}>
                                ‚úÖ S√≠
                            </button>
                            <button class="voto-btn ${miVoto && miVoto.voto === 'no' ? 'selected' : ''}" 
                                onclick="votar('${puntoId}', 'no')" ${miVoto ? 'disabled' : ''}>
                                ‚ùå No
                            </button>
                            <button class="voto-btn ${miVoto && miVoto.voto === 'abstencion' ? 'selected' : ''}" 
                                onclick="votar('${puntoId}', 'abstencion')" ${miVoto ? 'disabled' : ''}>
                                ‚ö™ Abstenci√≥n
                            </button>
                        </div>
                        ${window.usuarioActual.rol === 'coordinador' ? `
                            <button class="btn btn-danger btn-small" onclick="cerrarVotacion('${puntoId}')" style="margin-top: 10px; width: 100%;">
                                üîê Cerrar Votaci√≥n
                            </button>
                        ` : ''}
                        <div class="resultados-votacion">
                            <strong style="display: block; margin-bottom: 10px;">Resultados (${total} votos):</strong>
                            ${['si', 'no', 'abstencion'].map(tipo => {
                                const count = conteo[tipo];
                                const porcentaje = total > 0 ? Math.round((count / total) * 100) : 0;
                                const label = tipo === 'si' ? '‚úÖ S√≠' : tipo === 'no' ? '‚ùå No' : '‚ö™ Abstenci√≥n';
                                
                                let nombres = '';
                                if (votacion.conNombres) {
                                    const votantes = Object.entries(votos)
                                        .filter(([_, v]) => v.voto === tipo)
                                        .map(([nombre, _]) => nombre);
                                    if (votantes.length > 0) {
                                        nombres = `<div style="font-size: 12px; color: var(--text-light); margin-top: 4px;">${votantes.join(', ')}</div>`;
                                    }
                                }
                                
                                return `
                                    <div class="resultado-item">
                                        <strong>${label}</strong>
                                        <div class="resultado-barra">
                                            <div class="resultado-progreso" style="width: ${porcentaje}%;">
                                                ${porcentaje}%
                                            </div>
                                        </div>
                                        <span>${count}</span>
                                    </div>
                                    ${nombres}
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error cargando votaci√≥n:', error);
            }
        };

        // Votar
        window.votar = async function(puntoId, voto) {
            const votoRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion/votos/${window.usuarioActual.nombre}`);
            
            await set(votoRef, {
                nombre: window.usuarioActual.nombre,
                voto: voto,
                timestamp: Date.now()
            });
        };

        // Cerrar votaci√≥n
        window.cerrarVotacion = async function(puntoId) {
            if (!confirm('¬øCerrar la votaci√≥n? No se podr√°n a√±adir m√°s votos.')) {
                return;
            }
            
            const votacionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos/${puntoId}/votacion`);
            await update(votacionRef, { activa: false });
        };

        // Gesti√≥n de videollamada
        window.gestionarVideollamada = async function() {
            // Obtener enlaces actuales
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            const snapshot = await get(videollamadaRef);
            
            const enlaceActual1 = snapshot.exists() ? (snapshot.val().enlace1 || snapshot.val().enlace || '') : '';
            const enlaceActual2 = snapshot.exists() ? (snapshot.val().enlace2 || '') : '';
            
            // Mostrar formulario modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 600px;
                    width: 100%;
                    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
                ">
                    <h2 style="margin: 0 0 20px 0; color: var(--primary);">üé• Gestionar Enlaces de Videollamada</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">
                            1Ô∏è‚É£ Enlace Principal (obligatorio)
                        </label>
                        <input type="url" id="enlaceVideo1" value="${enlaceActual1}" 
                            placeholder="https://meet.google.com/xxx-xxxx-xxx" 
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text);">
                            2Ô∏è‚É£ Enlace Alternativo (opcional)
                        </label>
                        <input type="url" id="enlaceVideo2" value="${enlaceActual2}" 
                            placeholder="https://zoom.us/j/xxxxxxxxxx" 
                            style="width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 8px; font-size: 16px;">
                        <small style="color: var(--text-light); display: block; margin-top: 5px;">
                            Por si falla el enlace principal
                        </small>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="guardarEnlacesVideollamada()" 
                            style="flex: 1; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                            ‚úÖ Guardar
                        </button>
                        <button onclick="eliminarEnlacesVideollamada()" 
                            style="flex: 1; padding: 14px; background: var(--danger); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                            üóëÔ∏è Eliminar Todo
                        </button>
                        <button onclick="cerrarModalVideollamada()" 
                            style="padding: 14px 20px; background: var(--border); color: var(--text); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 16px;">
                            ‚ùå Cancelar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.id = 'modalVideollamada';
            
            // Focus en primer campo
            setTimeout(() => document.getElementById('enlaceVideo1').focus(), 100);
        };
        
        // Guardar enlaces de videollamada
        window.guardarEnlacesVideollamada = async function() {
            const enlace1 = document.getElementById('enlaceVideo1').value.trim();
            const enlace2 = document.getElementById('enlaceVideo2').value.trim();
            
            if (!enlace1) {
                alert('‚ö†Ô∏è Debes introducir al menos el enlace principal');
                document.getElementById('enlaceVideo1').focus();
                return;
            }
            
            // Validar URLs
            try {
                new URL(enlace1);
                if (enlace2) new URL(enlace2);
            } catch {
                alert('‚ö†Ô∏è Uno de los enlaces no es v√°lido. Aseg√∫rate de incluir https://');
                return;
            }
            
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            await set(videollamadaRef, {
                enlace1: enlace1,
                enlace2: enlace2 || null,
                timestamp: Date.now()
            });
            
            cerrarModalVideollamada();
        };
        
        // Eliminar enlaces de videollamada
        window.eliminarEnlacesVideollamada = async function() {
            if (!confirm('¬øSeguro que quieres eliminar todos los enlaces de videollamada?')) {
                return;
            }
            
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            await remove(videollamadaRef);
            
            cerrarModalVideollamada();
        };
        
        // Cerrar modal
        window.cerrarModalVideollamada = function() {
            const modal = document.getElementById('modalVideollamada');
            if (modal) modal.remove();
        };

        // Cargar videollamada
        window.cargarVideollamada = async function() {
            const bannerContainer = document.getElementById('videollamadaBanner');
            const gestionContainer = document.getElementById('gestionVideollamada');
            
            const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
            const snapshot = await get(videollamadaRef);
            
            // Bot√≥n de gesti√≥n para coordinador
            if (window.usuarioActual.rol === 'coordinador') {
                gestionContainer.innerHTML = `
                    <button class="btn btn-outline btn-small" onclick="gestionarVideollamada()" style="margin-bottom: 20px;">
                        üé• Gestionar Enlaces de Videollamada
                    </button>
                `;
            } else {
                gestionContainer.innerHTML = '';
            }
            
            // Banner de videollamada
            if (snapshot.exists()) {
                const videollamada = snapshot.val();
                
                // Compatibilidad con versi√≥n antigua (un solo enlace)
                const enlace1 = videollamada.enlace1 || videollamada.enlace;
                const enlace2 = videollamada.enlace2;
                
                // Obtener datos de la reuni√≥n para compartir
                const nombreReunion = getNombreReunion(window.sesionActual, window.fechaActual);
                const fechaFormateada = formatearFecha(window.fechaActual);
                
                bannerContainer.innerHTML = `
                    <div class="videollamada-banner">
                        <div class="videollamada-banner-content">
                            <div class="videollamada-icon">üé•</div>
                            <div class="videollamada-texto">
                                <strong>Videollamada${enlace2 ? 's Activas' : ' Activa'}</strong>
                                <small>Haz clic para unirte a la reuni√≥n virtual</small>
                            </div>
                        </div>
                        <div class="videollamada-actions">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <a href="${enlace1}" target="_blank" class="btn-videollamada">
                                    1Ô∏è‚É£ Enlace Principal
                                </a>
                                <button class="share-link-btn-icon" onclick="shareLinksManager.shareLink('${enlace1}', '${nombreReunion}', '${fechaFormateada}', '')" title="Compartir enlace">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                    </svg>
                                </button>
                            </div>
                            ${enlace2 ? `
                                <div style="display: flex; align-items: center; gap: 8px; margin-top: 8px;">
                                    <a href="${enlace2}" target="_blank" class="btn-videollamada">
                                        2Ô∏è‚É£ Enlace Alternativo
                                    </a>
                                    <button class="share-link-btn-icon" onclick="shareLinksManager.shareLink('${enlace2}', '${nombreReunion} (Alternativo)', '${fechaFormateada}', '')" title="Compartir enlace">
                                        <svg viewBox="0 0 24 24" width="16" height="16">
                                            <path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                        </svg>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            } else {
                bannerContainer.innerHTML = '';
            }
        };

        // Exportar a PDF
        window.exportarPDF = async function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n
            let y = 20;
            const lineHeight = 7;
            const pageHeight = 280;
            
            // Funci√≥n para a√±adir nueva p√°gina si es necesario
            const checkPage = () => {
                if (y > pageHeight) {
                    doc.addPage();
                    y = 20;
                }
            };
            
            // Encabezado
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('CEIP Capitulaciones de Santa Fe', 20, y);
            y += 10;
            
            // Nombre de la reuni√≥n
            doc.setFontSize(14);
            const nombreReunion = getNombreReunion(window.sesionActual, window.fechaActual);
            doc.text(nombreReunion, 20, y);
            y += 10;
            
            // Obtener datos
            const sesionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}`);
            const snapshot = await get(sesionRef);
            
            if (!snapshot.exists()) {
                alert('No se pueden cargar los datos de la reuni√≥n');
                return;
            }
            
            const sesionData = snapshot.val();
            
            // Participantes
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Participantes:', 20, y);
            y += lineHeight;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            
            if (sesionData.participantes) {
                Object.values(sesionData.participantes).forEach(p => {
                    checkPage();
                    const emoji = p.rol === 'coordinador' ? '* ' : '- ';
                    doc.text(`${emoji}${p.nombre} (${p.rol})`, 25, y);
                    y += lineHeight;
                });
            }
            
            y += 5;
            
            // Enlaces de videollamada
            if (sesionData.videollamada) {
                checkPage();
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Enlaces de Videollamada:', 20, y);
                y += lineHeight;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                // Compatibilidad con versi√≥n antigua
                const enlace1 = sesionData.videollamada.enlace1 || sesionData.videollamada.enlace;
                const enlace2 = sesionData.videollamada.enlace2;
                
                if (enlace1) {
                    checkPage();
                    doc.setTextColor(0, 0, 255);
                    doc.text('1. Enlace Principal:', 25, y);
                    y += lineHeight;
                    const lineas1 = doc.splitTextToSize(`   ${enlace1}`, 160);
                    lineas1.forEach(linea => {
                        checkPage();
                        doc.text(linea, 25, y);
                        y += lineHeight - 1;
                    });
                    doc.setTextColor(0, 0, 0);
                }
                
                if (enlace2) {
                    y += 2;
                    checkPage();
                    doc.setTextColor(0, 0, 255);
                    doc.text('2. Enlace Alternativo:', 25, y);
                    y += lineHeight;
                    const lineas2 = doc.splitTextToSize(`   ${enlace2}`, 160);
                    lineas2.forEach(linea => {
                        checkPage();
                        doc.text(linea, 25, y);
                        y += lineHeight - 1;
                    });
                    doc.setTextColor(0, 0, 0);
                }
                
                y += 5;
            }
            
            // Orden del d√≠a
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            checkPage();
            doc.text('Orden del Dia:', 20, y);
            y += lineHeight + 2;
            
            if (sesionData.puntos) {
                const puntosArray = Object.entries(sesionData.puntos).map(([id, data]) => ({ id, ...data }));
                puntosArray.sort((a, b) => a.orden - b.orden);
                
                puntosArray.forEach((punto, index) => {
                    checkPage();
                    
                    // N√∫mero y t√≠tulo del punto (en negrita y subrayado)
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    
                    // Texto del punto con subrayado
                    const textoPunto = `${index + 1}. ${punto.texto}`;
                    doc.text(textoPunto, 20, y);
                    
                    // A√±adir subrayado manualmente
                    const textWidth = doc.getTextWidth(textoPunto);
                    doc.setLineWidth(0.3);
                    doc.line(20, y + 0.5, 20 + textWidth, y + 0.5);
                    
                    y += lineHeight;
                    
                    // Aportaciones
                    if (punto.aportaciones) {
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        
                        const aportacionesArray = Object.values(punto.aportaciones);
                        aportacionesArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        aportacionesArray.forEach(aport => {
                            checkPage();
                            doc.text(`   ${aport.autor}:`, 25, y);
                            y += lineHeight;
                            
                            // Dividir texto largo en l√≠neas
                            const maxWidth = 160;
                            const lineas = doc.splitTextToSize(`   ${aport.texto}`, maxWidth);
                            lineas.forEach(linea => {
                                checkPage();
                                doc.text(linea, 25, y);
                                y += lineHeight - 1;
                            });
                            y += 2;
                        });
                    }
                    
                    // Votaci√≥n
                    if (punto.votacion && punto.votacion.activa) {
                        checkPage();
                        doc.setFont(undefined, 'bold');
                        const tipoVotacion = punto.votacion.conNombres ? 'Votacion Publica' : 'Votacion Anonima';
                        doc.text(`   ${tipoVotacion}:`, 25, y);
                        y += lineHeight;
                        
                        doc.setFont(undefined, 'normal');
                        
                        const votos = { si: [], no: [], abstencion: [] };
                        let total = 0;
                        
                        if (punto.votacion.votos) {
                            Object.values(punto.votacion.votos).forEach(v => {
                                total++;
                                votos[v.voto].push(v.nombre);
                            });
                        }
                        
                        ['si', 'no', 'abstencion'].forEach(tipo => {
                            checkPage();
                            const count = votos[tipo].length;
                            const porcentaje = total > 0 ? Math.round((count / total) * 100) : 0;
                            const label = tipo === 'si' ? 'Si' : tipo === 'no' ? 'No' : 'Abstencion';
                            doc.text(`      ${label}: ${count} (${porcentaje}%)`, 25, y);
                            y += lineHeight;
                            
                            if (punto.votacion.conNombres && count > 0) {
                                const nombres = votos[tipo].join(', ');
                                const lineas = doc.splitTextToSize(`         ${nombres}`, 155);
                                lineas.forEach(linea => {
                                    checkPage();
                                    doc.text(linea, 25, y);
                                    y += lineHeight - 1;
                                });
                            }
                        });
                    }
                    
                    // Documentos adjuntos
                    if (punto.documentos) {
                        checkPage();
                        doc.setFont(undefined, 'bold');
                        doc.text('   Documentos adjuntos:', 25, y);
                        y += lineHeight;
                        
                        doc.setFont(undefined, 'normal');
                        
                        const documentosArray = Object.values(punto.documentos);
                        documentosArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        documentosArray.forEach(docum => {
                            checkPage();
                            doc.text(`      - ${docum.nombre}`, 25, y);
                            y += lineHeight;
                            
                            // Enlace del documento
                            doc.setTextColor(0, 0, 255);
                            const lineas = doc.splitTextToSize(`        ${docum.link}`, 155);
                            lineas.forEach(linea => {
                                checkPage();
                                doc.text(linea, 25, y);
                                y += lineHeight - 1;
                            });
                            doc.setTextColor(0, 0, 0);
                            
                            // Info del autor (sin hora)
                            doc.text(`        (Subido por ${docum.autor})`, 25, y);
                            y += lineHeight + 1;
                        });
                    }
                    
                    y += 5;
                });
            } else {
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text('No hay puntos del orden del dia', 25, y);
                y += lineHeight;
            }
            
            // Chat General
            y += 5;
            checkPage();
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Chat General:', 20, y);
            y += lineHeight + 2;
            
            if (sesionData.chatGeneral) {
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                const mensajesArray = Object.values(sesionData.chatGeneral);
                mensajesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                mensajesArray.forEach(msg => {
                    checkPage();
                    doc.text(`   ${msg.autor}:`, 25, y);
                    y += lineHeight;
                    
                    // Dividir texto largo en l√≠neas
                    const maxWidth = 160;
                    const lineas = doc.splitTextToSize(`   ${msg.texto}`, maxWidth);
                    lineas.forEach(linea => {
                        checkPage();
                        doc.text(linea, 25, y);
                        y += lineHeight - 1;
                    });
                    y += 2;
                });
            } else {
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text('No hay mensajes en el chat general', 25, y);
                y += lineHeight;
            }
            
            // Guardar PDF
            const nombreArchivo = `Reunion_${window.sesionActual}_${window.fechaActual}.pdf`;
            doc.save(nombreArchivo);
            
            // Mostrar aviso de ChatGPT
            mostrarAvisoChatGPT();
        };

        // Generar texto del acta
        window.generarTextoActa = async function() {
            const sesionRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}`);
            const snapshot = await get(sesionRef);
            
            if (!snapshot.exists()) {
                alert('No se pueden cargar los datos de la reuni√≥n');
                return null;
            }
            
            const sesionData = snapshot.val();
            const nombreReunion = getNombreReunion(window.sesionActual, window.fechaActual);
            
            let texto = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            texto += 'CEIP CAPITULACIONES DE SANTA FE\n';
            texto += 'ACTA DE REUNI√ìN\n';
            texto += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            texto += `üìã ${nombreReunion}\n\n`;
            
            // Participantes
            texto += 'üë• PARTICIPANTES:\n';
            texto += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
            if (sesionData.participantes) {
                Object.values(sesionData.participantes).forEach(p => {
                    const emoji = p.rol === 'coordinador' ? 'üëë' : 'üë§';
                    texto += `${emoji} ${p.nombre} (${p.rol})\n`;
                });
            }
            texto += '\n';
            
            // Enlaces de videollamada
            if (sesionData.videollamada) {
                texto += 'üé• ENLACES DE VIDEOLLAMADA:\n';
                texto += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                const enlace1 = sesionData.videollamada.enlace1 || sesionData.videollamada.enlace;
                const enlace2 = sesionData.videollamada.enlace2;
                
                if (enlace1) {
                    texto += `1. Enlace Principal:\n   ${enlace1}\n\n`;
                }
                if (enlace2) {
                    texto += `2. Enlace Alternativo:\n   ${enlace2}\n\n`;
                }
            }
            
            // Orden del d√≠a
            texto += 'üìå ORDEN DEL D√çA:\n';
            texto += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            if (sesionData.puntos) {
                const puntosArray = Object.entries(sesionData.puntos).map(([id, data]) => ({ id, ...data }));
                puntosArray.sort((a, b) => a.orden - b.orden);
                
                puntosArray.forEach((punto, index) => {
                    texto += `**${index + 1}. ${punto.texto}**\n`;
                    texto += '‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n';
                    
                    // Aportaciones
                    if (punto.aportaciones) {
                        texto += '\nüí¨ Conversaci√≥n:\n';
                        const aportacionesArray = Object.values(punto.aportaciones);
                        aportacionesArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        aportacionesArray.forEach(aport => {
                            texto += `\n   ${aport.autor}:\n   ${aport.texto}\n`;
                        });
                        texto += '\n';
                    }
                    
                    // Votaci√≥n
                    if (punto.votacion && punto.votacion.activa) {
                        const tipoVotacion = punto.votacion.conNombres ? 'VOTACI√ìN P√öBLICA' : 'VOTACI√ìN AN√ìNIMA';
                        texto += `\nüó≥Ô∏è ${tipoVotacion}:\n`;
                        
                        const votos = { si: [], no: [], abstencion: [] };
                        let total = 0;
                        
                        if (punto.votacion.votos) {
                            Object.values(punto.votacion.votos).forEach(v => {
                                total++;
                                votos[v.voto].push(v.nombre);
                            });
                        }
                        
                        ['si', 'no', 'abstencion'].forEach(tipo => {
                            const count = votos[tipo].length;
                            const porcentaje = total > 0 ? Math.round((count / total) * 100) : 0;
                            const label = tipo === 'si' ? 'A favor' : tipo === 'no' ? 'En contra' : 'Abstenci√≥n';
                            texto += `   ${label}: ${count} (${porcentaje}%)\n`;
                            
                            if (punto.votacion.conNombres && count > 0) {
                                texto += `      ${votos[tipo].join(', ')}\n`;
                            }
                        });
                        texto += '\n';
                    }
                    
                    // Documentos adjuntos
                    if (punto.documentos) {
                        texto += '\nüìé Documentos adjuntos:\n';
                        const documentosArray = Object.values(punto.documentos);
                        documentosArray.sort((a, b) => a.timestamp - b.timestamp);
                        
                        documentosArray.forEach(docum => {
                            texto += `   - ${docum.nombre}\n`;
                            texto += `     ${docum.link}\n`;
                            texto += `     (Subido por ${docum.autor})\n\n`;
                        });
                    }
                    
                    texto += '\n';
                });
            }
            
            // Chat General
            texto += 'üí¨ CHAT GENERAL:\n';
            texto += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            
            if (sesionData.chatGeneral) {
                const mensajesArray = Object.values(sesionData.chatGeneral);
                mensajesArray.sort((a, b) => a.timestamp - b.timestamp);
                
                mensajesArray.forEach(msg => {
                    texto += `${msg.autor}:\n${msg.texto}\n\n`;
                });
            } else {
                texto += 'No hay mensajes en el chat general\n\n';
            }
            
            texto += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            texto += 'Fin del acta\n';
            
            return texto;
        };

        // Enviar por email
        window.enviarPorEmail = async function() {
            const textoActa = await generarTextoActa();
            
            if (!textoActa) return;
            
            const nombreReunion = getNombreReunion(window.sesionActual, window.fechaActual);
            const asunto = `Acta: ${nombreReunion}`;
            
            // Codificar para URL
            const asuntoEncoded = encodeURIComponent(asunto);
            const cuerpoEncoded = encodeURIComponent(textoActa);
            
            // Abrir cliente de correo
            window.location.href = `mailto:?subject=${asuntoEncoded}&body=${cuerpoEncoded}`;
            
            // Mostrar aviso de ChatGPT
            mostrarAvisoChatGPT();
        };

        // Copiar al portapapeles
        window.copiarActa = async function() {
            const textoActa = await generarTextoActa();
            
            if (!textoActa) return;
            
            try {
                await navigator.clipboard.writeText(textoActa);
                
                // Mostrar mensaje de confirmaci√≥n
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                toast.textContent = '‚úÖ Acta copiada al portapapeles';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
                
                // Mostrar aviso de ChatGPT
                mostrarAvisoChatGPT();
            } catch (err) {
                alert('Error al copiar. Por favor, intenta de nuevo.');
            }
        };

        // Mostrar aviso de ChatGPT despu√©s de exportar
        function mostrarAvisoChatGPT() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; z-index: 10001; padding: 20px;';
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 100%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ÑπÔ∏è</div>
                    <h3 style="color: var(--primary); margin-bottom: 15px;">Formato del Acta</h3>
                    <p style="color: var(--text); margin-bottom: 20px; line-height: 1.6;">
                        Recuerda darle formato correcto al acta en el ChatGPT del cole:
                    </p>
                    <a href="https://chatgpt.com/g/g-690a4f16ef6881919b013f61e39103da-ceip-capitulaciones" 
                       target="_blank"
                       style="display: inline-block; background: var(--primary); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-bottom: 15px;">
                        ü§ñ Abrir ChatGPT del CEIP Capitulaciones
                    </a>
                    <div>
                        <button onclick="this.closest('div').parentElement.parentElement.remove()" 
                                style="background: transparent; border: 2px solid var(--border); color: var(--text); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                            Entendido
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
        }

        // Salir de reuni√≥n
        window.salirDeReunion = function() {
            // Si es familia invitada, no puede volver al men√∫ principal
            if (window.esInvitadoFamilia) {
                alert('üë®‚Äçüë©‚Äçüëß Como invitado de familias, solo tienes acceso a esta reuni√≥n.\n\nPara salir, simplemente cierra esta pesta√±a del navegador.');
                return;
            }
            
            if (confirm('¬øSeguro que quieres salir de la reuni√≥n?')) {
                ocultarTituloReunion();
                location.reload();
            }
        };

        // Cargar puntos en configuraci√≥n con listener en tiempo real
        const setupPuntosListener = () => {
            if (!window.sesionActual || !window.fechaActual) return;
            
            const puntosRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/puntos`);
            onValue(puntosRef, async (snapshot) => {
                const lista = document.getElementById('listaPuntos');
                if (!lista) return;
                
                lista.innerHTML = '';

                // Inicializar ordenDia vac√≠o
                window.ordenDia = [];

                if (!snapshot.exists()) {
                    console.log('‚ÑπÔ∏è No hay puntos en el orden del d√≠a');
                    return;
                }

                const puntos = snapshot.val();
                const puntosArray = Object.entries(puntos).map(([id, data]) => ({ id, ...data }));
                puntosArray.sort((a, b) => a.orden - b.orden);

                // Actualizar window.ordenDia con los textos de los puntos
                window.ordenDia = puntosArray.map(punto => punto.texto);
                console.log('‚úÖ Orden del d√≠a actualizado:', window.ordenDia);

                puntosArray.forEach(punto => {
                    const div = document.createElement('div');
                    div.className = 'punto-item';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 600;">${punto.texto}</span>
                            <button class="btn btn-danger btn-small" onclick="eliminarPunto('${punto.id}')">‚ùå</button>
                        </div>
                    `;
                    lista.appendChild(div);
                });
            });
        };

        // Cuando se crea una sesi√≥n, configurar el listener
        const originalCrearSesion = window.crearSesion;
        window.crearSesion = function() {
            originalCrearSesion();
            setTimeout(setupPuntosListener, 500);
        };

        // ===== SISTEMA DE INSTALACI√ìN DE PWA =====
        let deferredPrompt;
        const installButton = document.getElementById('installButton');
        const iosInstallModal = document.getElementById('iosInstallModal');

        // Detectar si es iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        
        // Detectar si es standalone (ya instalado)
        const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                            window.navigator.standalone || 
                            document.referrer.includes('android-app://');

        // Mostrar bot√≥n de instalaci√≥n si no est√° instalado
        if (!isStandalone) {
            installButton.classList.remove('hidden');
        }

        // Variable para rastrear si el evento se dispar√≥
        let promptEventFired = false;

        // Para Android/Chrome - capturar el evento beforeinstallprompt
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('‚úÖ beforeinstallprompt disparado - PWA instalable');
            e.preventDefault();
            deferredPrompt = e;
            promptEventFired = true;
            installButton.classList.remove('hidden');
        });

        // Funci√≥n para instalar la app
        window.instalarApp = async function() {
            console.log('üîò Bot√≥n de instalaci√≥n pulsado');
            console.log('üì± iOS:', isIOS);
            console.log('üíæ deferredPrompt:', deferredPrompt ? 'Disponible' : 'No disponible');
            console.log('üéØ promptEventFired:', promptEventFired);
            
            if (isIOS) {
                // Mostrar instrucciones para iOS
                console.log('üì± Mostrando instrucciones iOS');
                iosInstallModal.classList.add('active');
            } else if (deferredPrompt) {
                // Android/Chrome - usar el prompt nativo
                console.log('üöÄ Mostrando prompt de instalaci√≥n nativo');
                try {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('üìä Resultado:', outcome);
                    
                    if (outcome === 'accepted') {
                        console.log('‚úÖ Usuario acept√≥ la instalaci√≥n');
                        installButton.classList.add('hidden');
                    } else {
                        console.log('‚ùå Usuario rechaz√≥ la instalaci√≥n');
                    }
                    deferredPrompt = null;
                } catch (error) {
                    console.error('‚ùå Error al mostrar prompt:', error);
                    mostrarInstruccionesManual();
                }
            } else {
                // Fallback mejorado
                console.log('‚ö†Ô∏è Prompt no disponible, mostrando instrucciones');
                mostrarInstruccionesManual();
            }
        };

        // Funci√≥n para mostrar instrucciones manuales
        function mostrarInstruccionesManual() {
            const esChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
            const esEdge = /Edg/.test(navigator.userAgent);
            
            let mensaje = 'üì± C√ìMO INSTALAR LA APP:\n\n';
            
            if (esChrome || esEdge) {
                mensaje += '‚úÖ Est√°s usando Chrome/Edge\n\n';
                mensaje += '1Ô∏è‚É£ Pulsa el men√∫ (‚ãÆ) arriba a la derecha\n';
                mensaje += '2Ô∏è‚É£ Busca la opci√≥n "Instalar aplicaci√≥n" o "A√±adir a pantalla de inicio"\n';
                mensaje += '3Ô∏è‚É£ Pulsa "Instalar"\n\n';
                mensaje += '‚ùì ¬øNo aparece la opci√≥n?\n';
                mensaje += '‚Ä¢ Aseg√∫rate de estar usando HTTPS\n';
                mensaje += '‚Ä¢ Recarga la p√°gina (F5)\n';
                mensaje += '‚Ä¢ Limpia la cach√© del navegador';
            } else {
                mensaje += '‚ö†Ô∏è Para instalar la PWA, usa:\n\n';
                mensaje += '‚Ä¢ Chrome para Android\n';
                mensaje += '‚Ä¢ Microsoft Edge\n';
                mensaje += '‚Ä¢ Safari para iOS\n\n';
                mensaje += 'Luego busca la opci√≥n de instalaci√≥n en el men√∫ del navegador.';
            }
            
            alert(mensaje);
        }

        // Cerrar modal de iOS
        window.cerrarModalIOS = function() {
            iosInstallModal.classList.remove('active');
        };

        // Event listener para el bot√≥n
        installButton.addEventListener('click', instalarApp);

        // Cerrar modal al hacer clic fuera
        iosInstallModal.addEventListener('click', (e) => {
            if (e.target === iosInstallModal) {
                cerrarModalIOS();
            }
        });

        // Ocultar bot√≥n despu√©s de instalar
        window.addEventListener('appinstalled', () => {
            installButton.classList.add('hidden');
            console.log('‚úÖ PWA instalada correctamente');
            alert('‚úÖ ¬°Aplicaci√≥n instalada correctamente!\n\nYa puedes encontrarla en tu men√∫ de aplicaciones.');
        });

        // Debug: Verificar despu√©s de 2 segundos si el evento se dispar√≥
        setTimeout(() => {
            if (!promptEventFired && !isIOS && !isStandalone) {
                console.warn('‚ö†Ô∏è El evento beforeinstallprompt NO se ha disparado');
                console.warn('Posibles causas:');
                console.warn('1. El manifest.json no est√° correctamente configurado');
                console.warn('2. El service worker no se registr√≥ correctamente');
                console.warn('3. Los iconos no se encuentran');
                console.warn('4. La app ya fue instalada anteriormente');
                console.warn('5. Chrome decidi√≥ no mostrar el prompt');
                
                // Cambiar el texto del bot√≥n para que sea m√°s claro
                installButton.innerHTML = 'üì± Instalar (Ver men√∫)';
                installButton.title = 'Si no funciona autom√°ticamente, busca "Instalar" en el men√∫ del navegador (‚ãÆ)';
            } else if (promptEventFired) {
                console.log('‚úÖ PWA correctamente configurada y lista para instalar');
            }
        }, 2000);
    </script>

    <script>
        // ===== SISTEMA DE CITACI√ìN CON QR =====
        
        // Generar citaci√≥n con QR
        window.generarCitacion = async function() {
            console.log('üîò Bot√≥n Generar Citaci√≥n pulsado');
            
            // Debug: verificar estado
            console.log('Estado actual:');
            console.log('  - sesionActual:', window.sesionActual);
            console.log('  - fechaActual:', window.fechaActual);
            console.log('  - ordenDia:', window.ordenDia);
            console.log('  - ordenDia.length:', window.ordenDia ? window.ordenDia.length : 'undefined');
            
            // Verificar que las variables existen
            if (!window.ordenDia) {
                alert('‚ùå Error: No se ha inicializado el orden del d√≠a. Recarga la p√°gina.');
                console.error('window.ordenDia no existe');
                return;
            }
            
            // Verificar que hay orden del d√≠a
            if (window.ordenDia.length === 0) {
                alert('‚ö†Ô∏è Debes a√±adir al menos un punto al orden del d√≠a antes de generar la citaci√≥n');
                return;
            }

            console.log('‚úÖ Verificaciones pasadas, generando citaci√≥n...');

            // Obtener videollamadas si existen
            let videollamadas = null;
            try {
                const videollamadaRef = ref(database, `sesiones/${window.sesionActual}/${window.fechaActual}/videollamada`);
                const snapshot = await get(videollamadaRef);
                if (snapshot.exists()) {
                    videollamadas = snapshot.val();
                    console.log('üìû Videollamadas encontradas:', videollamadas);
                }
            } catch (e) {
                console.log('‚ÑπÔ∏è No hay videollamadas configuradas:', e.message);
            }

            // Construir URL para el QR
            // Obtener la URL base correctamente para GitHub Pages
            let baseUrl = window.location.origin + window.location.pathname;
            
            // Si el pathname termina en .html, usarlo tal cual
            // Si termina en /, es un directorio (como github.io/repo/)
            // Asegurarse de que la URL sea correcta
            if (!baseUrl.endsWith('.html') && !baseUrl.endsWith('/')) {
                baseUrl += '/';
            }
            
            const qrUrl = `${baseUrl}?reunion=${encodeURIComponent(window.sesionActual)}&fecha=${window.fechaActual}`;
            
            console.log('üì± Generando QR con URL:', qrUrl);
            console.log('   - origin:', window.location.origin);
            console.log('   - pathname:', window.location.pathname);
            console.log('   - baseUrl:', baseUrl);

            try {
                // Llenar informaci√≥n del modal
                document.getElementById('citacion-tipo-reunion').textContent = window.sesionActual;
                
                // Formatear fecha
                const [year, month, day] = window.fechaActual.split('-');
                const meses = ['enero', 'febrero', 'marzo', 'abril', 'mayo', 'junio', 
                              'julio', 'agosto', 'septiembre', 'octubre', 'noviembre', 'diciembre'];
                const fechaFormateada = `${parseInt(day)} de ${meses[parseInt(month)-1]} de ${year}`;
                document.getElementById('citacion-fecha-reunion').textContent = fechaFormateada;

                // Llenar orden del d√≠a
                const listaOrdenDia = document.getElementById('citacion-orden-dia');
                listaOrdenDia.innerHTML = '';
                window.ordenDia.forEach((punto, index) => {
                    const li = document.createElement('li');
                    li.textContent = `${index + 1}. ${punto}`;
                    listaOrdenDia.appendChild(li);
                });

                console.log('‚úÖ Orden del d√≠a cargado');

                // Mostrar videollamadas si existen
                const videollamadasSection = document.getElementById('citacion-videollamadas-section');
                const videollamadasDiv = document.getElementById('citacion-videollamadas');
                
                if (videollamadas) {
                    videollamadasSection.style.display = 'block';
                    videollamadasDiv.innerHTML = '';
                    
                    const enlace1 = videollamadas.enlace1 || videollamadas.enlace;
                    if (enlace1) {
                        const div1 = document.createElement('div');
                        div1.style.cssText = 'padding: 10px; background: #f0f9ff; border-radius: 8px; margin-bottom: 10px;';
                        div1.innerHTML = `
                            <strong>1Ô∏è‚É£ Enlace Principal:</strong><br>
                            <a href="${enlace1}" target="_blank" style="color: var(--primary); word-break: break-all; font-size: 14px;">${enlace1}</a>
                        `;
                        videollamadasDiv.appendChild(div1);
                    }
                    
                    if (videollamadas.enlace2) {
                        const div2 = document.createElement('div');
                        div2.style.cssText = 'padding: 10px; background: #f0fdf4; border-radius: 8px;';
                        div2.innerHTML = `
                            <strong>2Ô∏è‚É£ Enlace Alternativo:</strong><br>
                            <a href="${videollamadas.enlace2}" target="_blank" style="color: var(--success); word-break: break-all; font-size: 14px;">${videollamadas.enlace2}</a>
                        `;
                        videollamadasDiv.appendChild(div2);
                    }
                    console.log('‚úÖ Videollamadas cargadas');
                } else {
                    videollamadasSection.style.display = 'none';
                }

                // Limpiar QR anterior si existe
                const qrcodeDiv = document.getElementById('qrcode');
                qrcodeDiv.innerHTML = '';

                console.log('üîÑ Generando c√≥digo QR...');
                
                // Verificar que QRCode est√° disponible
                if (typeof QRCode === 'undefined') {
                    throw new Error('La librer√≠a QRCode no est√° cargada. Verifica tu conexi√≥n a internet.');
                }

                // Generar nuevo QR
                new QRCode(qrcodeDiv, {
                    text: qrUrl,
                    width: 200,
                    height: 200,
                    colorDark: '#2563eb',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });

                console.log('‚úÖ QR generado correctamente');

                // Mostrar enlace autom√°ticamente
                const enlaceInput = document.getElementById('enlaceReunionMostrado');
                if (enlaceInput) {
                    enlaceInput.value = qrUrl;
                    window.enlaceReunionActual = qrUrl; // Guardar para compartir
                }

                // Mostrar/ocultar secci√≥n de enlace para familias (solo CONSEJO ESCOLAR)
                const enlaceFamiliasSection = document.getElementById('enlaceFamiliasSection');
                const enlaceFamiliasInput = document.getElementById('enlaceFamiliasMostrado');
                
                if (window.sesionActual === 'consejo-escolar' || window.sesionActual === 'CONSEJO ESCOLAR') {
                    // Generar enlace especial para familias
                    const qrUrlFamilias = qrUrl + '&invitado=familia';
                    enlaceFamiliasInput.value = qrUrlFamilias;
                    window.enlaceFamiliasActual = qrUrlFamilias;
                    enlaceFamiliasSection.style.display = 'block';
                    console.log('‚úÖ Enlace para familias generado:', qrUrlFamilias);
                } else {
                    enlaceFamiliasSection.style.display = 'none';
                }

                // Mostrar modal
                document.getElementById('citacionModal').classList.add('active');
                
                console.log('‚úÖ Modal mostrado');
                
            } catch (error) {
                console.error('‚ùå Error al generar la citaci√≥n:', error);
                alert('‚ùå Error al generar la citaci√≥n: ' + error.message + '\n\nRevisa la consola del navegador (F12) para m√°s detalles.');
            }
        };

        // Cerrar modal de citaci√≥n
        window.cerrarCitacion = function() {
            document.getElementById('citacionModal').classList.remove('active');
        };

        // Descargar QR como imagen
        window.descargarQR = function() {
            const qrcodeDiv = document.getElementById('qrcode');
            const canvas = qrcodeDiv.querySelector('canvas');
            
            if (!canvas) {
                alert('‚ö†Ô∏è Error al generar el QR');
                return;
            }

            // Crear un canvas m√°s grande con informaci√≥n adicional
            const finalCanvas = document.createElement('canvas');
            const ctx = finalCanvas.getContext('2d');
            
            // Dimensiones del canvas final
            finalCanvas.width = 400;
            finalCanvas.height = 550;
            
            // Fondo blanco
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);
            
            // Header azul
            ctx.fillStyle = '#2563eb';
            ctx.fillRect(0, 0, finalCanvas.width, 100);
            
            // Texto del header
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üìã CONVOCATORIA', finalCanvas.width / 2, 35);
            
            ctx.font = '16px Arial';
            ctx.fillText('CEIP Capitulaciones', finalCanvas.width / 2, 60);
            ctx.fillText(window.sesionActual, finalCanvas.width / 2, 85);
            
            // Informaci√≥n de la reuni√≥n
            ctx.fillStyle = '#1e293b';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            const fecha = document.getElementById('citacion-fecha-reunion').textContent;
            ctx.fillText(fecha, finalCanvas.width / 2, 130);
            
            // Dibujar el QR en el centro
            ctx.drawImage(canvas, 100, 160, 200, 200);
            
            // Texto debajo del QR
            ctx.fillStyle = '#64748b';
            ctx.font = 'bold 16px Arial';
            ctx.fillText('Escanea para unirte', finalCanvas.width / 2, 390);
            
            ctx.font = '14px Arial';
            ctx.fillText('directamente a la reuni√≥n', finalCanvas.width / 2, 415);
            
            // L√≠nea decorativa
            ctx.strokeStyle = '#e2e8f0';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(50, 440);
            ctx.lineTo(350, 440);
            ctx.stroke();
            
            // Footer
            ctx.fillStyle = '#94a3b8';
            ctx.font = '12px Arial';
            ctx.fillText('Teletrabajo Capitulaciones', finalCanvas.width / 2, 470);
            ctx.fillText(`Generado: ${new Date().toLocaleDateString('es-ES')}`, finalCanvas.width / 2, 490);
            
            // Descargar
            finalCanvas.toBlob(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Citacion_${window.sesionActual}_${window.fechaActual}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('‚úÖ Imagen descargada. Ahora puedes compartirla por WhatsApp o email');
            });
        };

        // Compartir citaci√≥n
        window.compartirCitacion = async function() {
            // Construir URL correctamente para GitHub Pages
            let baseUrl = window.location.origin + window.location.pathname;
            if (!baseUrl.endsWith('.html') && !baseUrl.endsWith('/')) {
                baseUrl += '/';
            }
            const qrUrl = `${baseUrl}?reunion=${encodeURIComponent(window.sesionActual)}&fecha=${window.fechaActual}`;
            const fecha = document.getElementById('citacion-fecha-reunion').textContent;
            
            // Texto para compartir
            let textoCompleto = `üìã *CONVOCATORIA DE REUNI√ìN*\n\n`;
            textoCompleto += `*CEIP Capitulaciones de Santa Fe*\n`;
            textoCompleto += `*${window.sesionActual}*\n`;
            textoCompleto += `üìÖ ${fecha}\n\n`;
            textoCompleto += `*üìå ORDEN DEL D√çA:*\n`;
            
            window.ordenDia.forEach((punto, index) => {
                textoCompleto += `${index + 1}. ${punto}\n`;
            });
            
            textoCompleto += `\n*üì± ACCESO R√ÅPIDO:*\n`;
            textoCompleto += `${qrUrl}\n\n`;
            textoCompleto += `üëÜ Pulsa el enlace o escanea el QR para unirte directamente`;

            // Intentar usar Web Share API si est√° disponible
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Convocatoria: ${window.sesionActual}`,
                        text: textoCompleto,
                        url: qrUrl
                    });
                    console.log('‚úÖ Compartido correctamente');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.log('Compartir cancelado o no disponible');
                        compartirPorWhatsApp(textoCompleto);
                    }
                }
            } else {
                // Fallback: abrir WhatsApp Web
                compartirPorWhatsApp(textoCompleto);
            }
        };

        function compartirPorWhatsApp(texto) {
            const textoEncoded = encodeURIComponent(texto);
            const whatsappUrl = `https://wa.me/?text=${textoEncoded}`;
            
            // Copiar tambi√©n al portapapeles
            if (navigator.clipboard) {
                navigator.clipboard.writeText(texto).then(() => {
                    console.log('‚úÖ Texto copiado al portapapeles');
                });
            }
            
            // Abrir WhatsApp
            window.open(whatsappUrl, '_blank');
            
            alert('üì± Se abrir√° WhatsApp con el texto de la convocatoria.\n\nüí° El texto tambi√©n se ha copiado al portapapeles por si quieres pegarlo en otro sitio.');
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('citacionModal').addEventListener('click', (e) => {
            if (e.target.id === 'citacionModal') {
                cerrarCitacion();
            }
        });

        // ===== AUTO-UNIRSE A REUNI√ìN DESDE QR =====
        
        // Detectar par√°metros en la URL y auto-unirse
        window.addEventListener('load', () => {
            console.log('üîç Verificando par√°metros en URL...');
            console.log('   URL completa:', window.location.href);
            console.log('   Search params:', window.location.search);
            
            const urlParams = new URLSearchParams(window.location.search);
            const reunion = urlParams.get('reunion');
            const fecha = urlParams.get('fecha');
            const invitado = urlParams.get('invitado'); // Detectar si es familia
            
            console.log('   Par√°metros detectados:');
            console.log('   - reunion:', reunion);
            console.log('   - fecha:', fecha);
            console.log('   - invitado:', invitado);
            
            if (reunion && fecha) {
                console.log('‚úÖ Par√°metros v√°lidos detectados, iniciando auto-uni√≥n...');
                
                // Determinar tipo de invitado
                const esFamilia = invitado === 'familia';
                const textoTipo = esFamilia ? 'üë®‚Äçüë©‚Äçüëß Acceso para Familias' : 'üì± Cargando reuni√≥n...';
                const colorTipo = esFamilia ? '#8b5cf6' : '#2563eb';
                
                // Mostrar un indicador visual inmediato
                document.body.innerHTML += `
                    <div style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: white;
                        padding: 30px;
                        border-radius: 12px;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                        z-index: 99999;
                        text-align: center;
                    " id="loadingAutoJoin">
                        <h2 style="color: ${colorTipo}; margin: 0 0 15px 0;">${textoTipo}</h2>
                        <p style="margin: 0; color: #64748b;">${reunion}<br>${fecha}</p>
                        <div style="margin-top: 20px;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: ${colorTipo}; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes spin { to { transform: rotate(360deg); } }
                    </style>
                `;
                
                // Esperar a que Firebase est√© listo
                const esperarFirebase = setInterval(() => {
                    if (typeof database !== 'undefined' && database) {
                        clearInterval(esperarFirebase);
                        console.log('‚úÖ Firebase listo, procediendo con auto-uni√≥n');
                        setTimeout(() => {
                            autoUnirseDesdeQR(reunion, fecha, esFamilia);
                        }, 500);
                    } else {
                        console.log('‚è≥ Esperando a que Firebase se inicialice...');
                    }
                }, 200);
                
                // Timeout de seguridad
                setTimeout(() => {
                    clearInterval(esperarFirebase);
                    if (typeof database === 'undefined') {
                        console.error('‚ùå Firebase no se inicializ√≥ a tiempo');
                        alert('Error: No se pudo conectar a la base de datos. Recarga la p√°gina.');
                        document.getElementById('loadingAutoJoin')?.remove();
                    }
                }, 10000);
            } else {
                console.log('‚ÑπÔ∏è No hay par√°metros de auto-uni√≥n en la URL');
            }
        });

        async function autoUnirseDesdeQR(tipoReunion, fecha, esFamilia = false) {
            console.log('üöÄ Ejecutando autoUnirseDesdeQR...');
            console.log('   - Tipo reuni√≥n:', tipoReunion);
            console.log('   - Fecha:', fecha);
            console.log('   - Es familia:', esFamilia);
            
            try {
                // Ocultar el loading
                document.getElementById('loadingAutoJoin')?.remove();
                
                // Mensaje diferente para familias
                const mensajePrompt = esFamilia 
                    ? `üë®‚Äçüë©‚Äçüëß Acceso para FAMILIAS\n\n${tipoReunion}\nFecha: ${fecha}\n\n¬øCu√°l es tu nombre?`
                    : `üì± Vas a unirte a:\n\n${tipoReunion}\nFecha: ${fecha}\n\n¬øCu√°l es tu nombre?`;
                
                // Pedir nombre al usuario
                const nombre = prompt(mensajePrompt);
                
                if (!nombre || nombre.trim() === '') {
                    console.log('‚ùå Nombre no proporcionado, cancelando auto-uni√≥n');
                    // Limpiar par√°metros de la URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                console.log('‚úÖ Nombre proporcionado:', nombre.trim());

                // Normalizar nombre: sin espacios extra, min√∫sculas para la key
                const nombreNormalizado = nombre.trim().toLowerCase().replace(/\s+/g, '-');
                
                // Determinar el rol
                const rol = esFamilia ? 'familia' : 'maestro';

                // Guardar datos del usuario
                window.usuarioActual = {
                    nombre: nombre.trim(),
                    nombreKey: nombreNormalizado,
                    rol: rol,
                    timestamp: Date.now()
                };
                
                // Marcar si es invitado familia (para restringir navegaci√≥n)
                window.esInvitadoFamilia = esFamilia;

                window.sesionActual = tipoReunion;
                window.fechaActual = fecha;

                console.log('üìä Datos del usuario guardados');
                console.log('üîç Verificando si la reuni√≥n existe...');

                // Verificar que la reuni√≥n existe
                const sesionRef = ref(database, `sesiones/${tipoReunion}/${fecha}`);
                const snapshot = await get(sesionRef);

                if (!snapshot.exists()) {
                    console.error('‚ùå La reuni√≥n no existe en la base de datos');
                    alert('‚ö†Ô∏è Esta reuni√≥n a√∫n no ha sido creada por el coordinador.\n\nPor favor, espera a que se inicie la reuni√≥n.');
                    // Limpiar par√°metros de la URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }

                console.log('‚úÖ La reuni√≥n existe');
                const sesionData = snapshot.val();
                console.log('üìã Datos de la reuni√≥n:', sesionData);

                // Registrar participante usando nombre normalizado como key
                console.log('üë§ Registrando participante...');
                const participanteRef = ref(database, `sesiones/${tipoReunion}/${fecha}/participantes/${nombreNormalizado}`);
                await set(participanteRef, {
                    nombre: nombre.trim(),
                    rol: rol,
                    timestamp: Date.now()
                });
                console.log('‚úÖ Participante registrado como:', rol);

                console.log('üì∫ Cambiando a pantalla de reuni√≥n...');
                
                // Ir directamente a la pantalla de reuni√≥n usando window para asegurar acceso
                window.cambiarPantalla('screenReunion');
                
                console.log('üì• Cargando contenido de la reuni√≥n...');
                window.cargarReunion();

                console.log('‚úÖ Auto-uni√≥n completada exitosamente');
                
                // Limpiar par√°metros de la URL sin recargar la p√°gina
                window.history.replaceState({}, document.title, window.location.pathname);
                
                // Mensaje de confirmaci√≥n diferente para familias
                const mensajeExito = esFamilia 
                    ? '‚úÖ Bienvenido/a al Consejo Escolar\n\nTe has unido como representante de familias.'
                    : '‚úÖ Te has unido correctamente a la reuni√≥n';
                
                setTimeout(() => {
                    alert(mensajeExito);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error en autoUnirseDesdeQR:', error);
                alert(`‚ùå Error al unirse a la reuni√≥n:\n\n${error.message}\n\nContacta con el coordinador.`);
                // Limpiar par√°metros de la URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    </script>

    <script>
        // Service Worker - Registro mejorado
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js', { scope: '/' })
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üîÑ Nueva versi√≥n disponible');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Error registrando Service Worker:', error);
                    });
            });
        }
    </script>

    <!-- ============================================ -->
    <!-- M√ìDULO DE COMPARTIR ENLACES DE VIDEOLLAMADAS -->
    <!-- ============================================ -->
    <script>
        class ShareLinksManager {
            constructor() {
                this.initializeStyles();
            }

            async shareLink(url, meetingTitle = 'Reuni√≥n', meetingDate = '', meetingTime = '') {
                const message = this.buildShareMessage(url, meetingTitle, meetingDate, meetingTime);
                this.showShareMenu(url, message, meetingTitle);
            }

            buildShareMessage(url, title, date, time) {
                let message = `üìπ *${title}*\n\n`;
                if (date) message += `üìÖ Fecha: ${date}\n`;
                if (time) message += `üïí Hora: ${time}\n`;
                message += `\nüîó Enlace de videollamada:\n${url}`;
                return message;
            }

            showShareMenu(url, message, title) {
                const overlay = document.createElement('div');
                overlay.className = 'share-overlay';
                overlay.onclick = () => overlay.remove();

                const menu = document.createElement('div');
                menu.className = 'share-menu';
                menu.onclick = (e) => e.stopPropagation();

                menu.innerHTML = `
                    <div class="share-menu-header">
                        <h3>Compartir enlace</h3>
                        <button class="share-close-btn" onclick="this.closest('.share-overlay').remove()">√ó</button>
                    </div>
                    <div class="share-menu-content">
                        <div class="share-link-preview">
                            <div class="share-link-text">${url}</div>
                        </div>
                        <div class="share-options">
                            <button class="share-option whatsapp" data-action="whatsapp">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                </svg>
                                <span>WhatsApp</span>
                            </button>
                            
                            <button class="share-option email" data-action="email">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                                </svg>
                                <span>Email</span>
                            </button>

                            <button class="share-option copy" data-action="copy">
                                <svg viewBox="0 0 24 24" width="24" height="24">
                                    <path fill="currentColor" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                                </svg>
                                <span>Copiar enlace</span>
                            </button>

                            ${this.canUseNativeShare() ? `
                                <button class="share-option native" data-action="native">
                                    <svg viewBox="0 0 24 24" width="24" height="24">
                                        <path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                                    </svg>
                                    <span>Compartir...</span>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;

                overlay.appendChild(menu);
                document.body.appendChild(overlay);

                menu.querySelectorAll('.share-option').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        this.handleShareAction(action, url, message, title);
                    });
                });
            }

            async handleShareAction(action, url, message, title) {
                switch(action) {
                    case 'whatsapp':
                        this.shareViaWhatsApp(url, message);
                        break;
                    case 'email':
                        this.shareViaEmail(url, message, title);
                        break;
                    case 'copy':
                        await this.copyToClipboard(url);
                        break;
                    case 'native':
                        await this.shareNative(url, message, title);
                        break;
                }
                document.querySelector('.share-overlay')?.remove();
            }

            shareViaWhatsApp(url, message) {
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
                window.open(whatsappUrl, '_blank');
                this.showToast('Abriendo WhatsApp...', 'success');
            }

            shareViaEmail(url, message, title) {
                const subject = encodeURIComponent(`Invitaci√≥n: ${title}`);
                const body = encodeURIComponent(message);
                const mailtoUrl = `mailto:?subject=${subject}&body=${body}`;
                window.location.href = mailtoUrl;
                this.showToast('Abriendo cliente de correo...', 'success');
            }

            async copyToClipboard(url) {
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(url);
                        this.showToast('¬°Enlace copiado al portapapeles!', 'success');
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.value = url;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        this.showToast('¬°Enlace copiado!', 'success');
                    }
                } catch (err) {
                    console.error('Error al copiar:', err);
                    this.showToast('Error al copiar el enlace', 'error');
                }
            }

            async shareNative(url, message, title) {
                try {
                    await navigator.share({
                        title: title,
                        text: message,
                        url: url
                    });
                    this.showToast('Compartido correctamente', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Error al compartir:', err);
                        this.showToast('Error al compartir', 'error');
                    }
                }
            }

            canUseNativeShare() {
                return navigator.share !== undefined;
            }

            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `share-toast share-toast-${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }

            initializeStyles() {
                if (document.getElementById('share-links-styles')) return;

                const style = document.createElement('style');
                style.id = 'share-links-styles';
                style.textContent = `
                    .share-overlay {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                        animation: fadeIn 0.2s ease;
                    }

                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }

                    .share-menu {
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
                        max-width: 400px;
                        width: 90%;
                        animation: slideUp 0.3s ease;
                    }

                    @keyframes slideUp {
                        from { 
                            transform: translateY(20px);
                            opacity: 0;
                        }
                        to { 
                            transform: translateY(0);
                            opacity: 1;
                        }
                    }

                    .share-menu-header {
                        padding: 20px;
                        border-bottom: 1px solid #e0e0e0;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }

                    .share-menu-header h3 {
                        margin: 0;
                        font-size: 20px;
                        color: #333;
                    }

                    .share-close-btn {
                        background: none;
                        border: none;
                        font-size: 28px;
                        color: #666;
                        cursor: pointer;
                        padding: 0;
                        width: 30px;
                        height: 30px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: all 0.2s;
                    }

                    .share-close-btn:hover {
                        background: #f0f0f0;
                        color: #333;
                    }

                    .share-menu-content {
                        padding: 20px;
                    }

                    .share-link-preview {
                        background: #f5f5f5;
                        padding: 12px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                    }

                    .share-link-text {
                        font-size: 13px;
                        color: #666;
                        word-break: break-all;
                        line-height: 1.4;
                    }

                    .share-options {
                        display: grid;
                        grid-template-columns: repeat(2, 1fr);
                        gap: 10px;
                    }

                    .share-option {
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 8px;
                        padding: 16px;
                        border: 2px solid #e0e0e0;
                        border-radius: 10px;
                        background: white;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-size: 14px;
                        color: #333;
                    }

                    .share-option:hover {
                        border-color: #4CAF50;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                    }

                    .share-option:active {
                        transform: translateY(0);
                    }

                    .share-option svg {
                        width: 32px;
                        height: 32px;
                    }

                    .share-option.whatsapp {
                        color: #25D366;
                    }

                    .share-option.whatsapp:hover {
                        border-color: #25D366;
                        background: #f0fdf4;
                    }

                    .share-option.email {
                        color: #EA4335;
                    }

                    .share-option.email:hover {
                        border-color: #EA4335;
                        background: #fef2f2;
                    }

                    .share-option.copy {
                        color: #1976D2;
                    }

                    .share-option.copy:hover {
                        border-color: #1976D2;
                        background: #eff6ff;
                    }

                    .share-option.native {
                        color: #666;
                    }

                    .share-option.native:hover {
                        border-color: #666;
                        background: #f9fafb;
                    }

                    .share-toast {
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%) translateY(100px);
                        background: #323232;
                        color: white;
                        padding: 12px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                        z-index: 10001;
                        transition: transform 0.3s ease;
                        font-size: 14px;
                    }

                    .share-toast.show {
                        transform: translateX(-50%) translateY(0);
                    }

                    .share-toast-success {
                        background: #4CAF50;
                    }

                    .share-toast-error {
                        background: #f44336;
                    }

                    .share-link-btn {
                        display: inline-flex;
                        align-items: center;
                        gap: 6px;
                        padding: 8px 12px;
                        background: #4CAF50;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 13px;
                        transition: all 0.2s;
                        margin-left: 10px;
                        text-decoration: none;
                    }

                    .share-link-btn:hover {
                        background: #45a049;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
                    }

                    .share-link-btn:active {
                        transform: translateY(0);
                    }

                    .share-link-btn svg {
                        width: 16px;
                        height: 16px;
                    }

                    /* Bot√≥n peque√±o solo con icono */
                    .share-link-btn-icon {
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        padding: 8px;
                        background: #4CAF50;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        transition: all 0.2s;
                        min-width: 32px;
                        min-height: 32px;
                    }

                    .share-link-btn-icon:hover {
                        background: #45a049;
                        transform: translateY(-1px);
                        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
                    }

                    .share-link-btn-icon:active {
                        transform: translateY(0);
                    }

                    .share-link-btn-icon svg {
                        width: 16px;
                        height: 16px;
                    }

                    @media (max-width: 480px) {
                        .share-options {
                            grid-template-columns: 1fr;
                        }
                        
                        .share-menu {
                            width: 95%;
                        }
                    }
                `;
                
                document.head.appendChild(style);
            }
        }

        // Funciones auxiliares para el t√≠tulo de la reuni√≥n
        window.mostrarTituloReunion = function(titulo) {
            const banner = document.getElementById('meetingTitleBanner');
            if (banner) {
                banner.textContent = titulo;
                banner.style.display = 'block';
            }
        };

        window.ocultarTituloReunion = function() {
            const banner = document.getElementById('meetingTitleBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        };

        // Crear instancia global de ShareLinksManager ANTES de usarla
        const shareLinksManager = new ShareLinksManager();

        // Funci√≥n para compartir enlace de reuni√≥n
        window.compartirEnlaceReunion = function() {
            const url = window.enlaceReunionActual || (window.location.origin + window.location.pathname + '?fecha=' + window.fechaActual + '&reunion=' + window.sesionActual);
            const nombreReunion = getNombreReunion(window.sesionActual, window.fechaActual);
            shareLinksManager.shareLink(url, nombreReunion, formatearFecha(window.fechaActual), '');
        };

        // Funci√≥n para copiar enlace al portapapeles
        window.copiarEnlaceReunion = async function() {
            const enlaceInput = document.getElementById('enlaceReunionMostrado');
            if (!enlaceInput || !enlaceInput.value) {
                alert('No hay enlace disponible');
                return;
            }

            try {
                await navigator.clipboard.writeText(enlaceInput.value);
                
                // Mostrar confirmaci√≥n
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                toast.textContent = '‚úÖ Enlace copiado al portapapeles';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            } catch (err) {
                // Fallback: seleccionar texto
                enlaceInput.select();
                document.execCommand('copy');
                
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #4CAF50; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                toast.textContent = '‚úÖ Enlace copiado al portapapeles';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        };

        // Funci√≥n para compartir enlace de familias
        window.compartirEnlaceFamilias = function() {
            const url = window.enlaceFamiliasActual;
            if (!url) {
                alert('No hay enlace de familias disponible');
                return;
            }
            const nombreReunion = 'Consejo Escolar (Familias)';
            shareLinksManager.shareLink(url, nombreReunion, formatearFecha(window.fechaActual), '');
        };

        // Funci√≥n para copiar enlace de familias al portapapeles
        window.copiarEnlaceFamilias = async function() {
            const enlaceInput = document.getElementById('enlaceFamiliasMostrado');
            if (!enlaceInput || !enlaceInput.value) {
                alert('No hay enlace de familias disponible');
                return;
            }

            try {
                await navigator.clipboard.writeText(enlaceInput.value);
                
                // Mostrar confirmaci√≥n
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #8b5cf6; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                toast.textContent = '‚úÖ Enlace para familias copiado';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            } catch (err) {
                // Fallback: seleccionar texto
                enlaceInput.select();
                document.execCommand('copy');
                
                const toast = document.createElement('div');
                toast.style.cssText = 'position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #8b5cf6; color: white; padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10000; font-size: 14px;';
                toast.textContent = '‚úÖ Enlace para familias copiado';
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        };

        // Funci√≥n helper para a√±adir bot√≥n de compartir a un enlace existente
        function addShareButton(linkElement, meetingTitle, meetingDate, meetingTime) {
            const url = linkElement.href || linkElement.textContent;
            
            const shareBtn = document.createElement('button');
            shareBtn.className = 'share-link-btn';
            shareBtn.innerHTML = `
                <svg viewBox="0 0 24 24" width="16" height="16">
                    <path fill="currentColor" d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/>
                </svg>
                Compartir
            `;
            
            shareBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                shareLinksManager.shareLink(url, meetingTitle, meetingDate, meetingTime);
            };
            
            linkElement.parentNode.insertBefore(shareBtn, linkElement.nextSibling);
            return shareBtn;
        }

        // Exponer funciones globalmente
        window.shareLinksManager = shareLinksManager;
        window.addShareButton = addShareButton;

        // Funciones del dropdown de acta
        window.toggleActaDropdown = function() {
            const dropdown = document.getElementById('actaDropdown');
            dropdown.classList.toggle('active');
        };

        window.closeActaDropdown = function() {
            const dropdown = document.getElementById('actaDropdown');
            dropdown.classList.remove('active');
        };

        // Cerrar dropdown al hacer clic fuera
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('actaDropdown');
            if (dropdown && !dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Funciones del modal de ayuda
        window.toggleHelpModal = function() {
            const modal = document.getElementById('helpModal');
            modal.classList.toggle('active');
        };

        window.switchHelpTab = function(tab) {
            // Cambiar pesta√±as activas
            document.querySelectorAll('.help-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.help-tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'coordinador') {
                document.querySelectorAll('.help-tab')[0].classList.add('active');
                document.getElementById('helpCoordinador').classList.add('active');
            } else if (tab === 'maestro') {
                document.querySelectorAll('.help-tab')[1].classList.add('active');
                document.getElementById('helpMaestro').classList.add('active');
            } else if (tab === 'infografia') {
                document.querySelectorAll('.help-tab')[2].classList.add('active');
                document.getElementById('helpInfografia').classList.add('active');
            }
        };

        // Abrir infograf√≠a en ventana nueva
        window.abrirInfografiaVentana = function() {
            window.open('infografia-reunion.jpg', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        };

        // Cerrar modal al hacer clic fuera
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleHelpModal();
            }
        });
    </script>
</body>
</html>